# 動作確認手順（通知機能中心）

## 前提条件

- Supabaseで`notifications`テーブルを作成済み（`supabase_notifications_table.sql`を実行）
- store-web: LINEとメールアドレスでログイン済み
- organizer-web: メールアドレスでログイン済み

**注意**: パスワードリセット機能は実装済みですが、Supabaseのメール送信制限によりテストできません。通知機能の動作確認に集中します。

---

## 1. 通知機能の確認（申し込み時）

### 1-1. 出店者アプリでイベントに申し込む

1. **store-web**にログイン（LINEまたはメール）
2. イベント一覧から任意のイベントを選択
3. 「このイベントに申し込む」ボタンをクリック
4. ✅ 「申し込みが完了しました！」と表示されることを確認

### 1-2. 主催者アプリで通知を確認

1. **organizer-web**にログイン
2. ナビゲーションバーの「通知」タブを確認
3. ✅ 通知アイコンに未読バッジ（赤い丸）が表示されることを確認
4. 「通知」タブをクリック
5. ✅ 「新しい出店申し込み」という通知が表示されることを確認
   - タイトル: 「新しい出店申し込み」
   - メッセージ: 「[イベント名]に新しい出店申し込みがありました。」
   - イベント名が表示される
   - 通知の日時が表示される
6. ✅ 通知をクリックして既読になることを確認（背景色が変わる）
7. ✅ 未読バッジが消えることを確認

---

## 2. 通知機能の確認（承認時）

### 2-1. 主催者アプリで申し込みを承認

1. **organizer-web**にログイン
2. イベント一覧から、申し込みがあったイベントを選択
3. 「申し込みを確認」ボタンをクリック
4. 申し込み一覧で「承認」ボタンをクリック
5. ✅ 「申し込みを承認しました」と表示されることを確認

### 2-2. 出店者アプリで通知を確認

1. **store-web**にログイン（申し込みをしたアカウント）
2. ナビゲーションバーの「通知」タブを確認
3. ✅ 通知アイコンに未読バッジ（赤い丸）が表示されることを確認
4. 「通知」タブをクリック
5. ✅ 「出店申し込みが承認されました」という通知が表示されることを確認
   - タイトル: 「出店申し込みが承認されました」
   - メッセージ: 「[イベント名]への出店申し込みが承認されました。」
   - イベント名が表示される
6. ✅ 通知をクリックして既読になることを確認
7. ✅ 未読バッジが消えることを確認

---

## 3. 通知機能の確認（却下時）

### 3-1. 主催者アプリで申し込みを却下

1. **organizer-web**にログイン
2. イベント一覧から、申し込みがあったイベントを選択
3. 「申し込みを確認」ボタンをクリック
4. 申し込み一覧で「却下」ボタンをクリック
5. ✅ 「申し込みを却下しました」と表示されることを確認

### 3-2. 出店者アプリで通知を確認

1. **store-web**にログイン（申し込みをしたアカウント）
2. ナビゲーションバーの「通知」タブを確認
3. ✅ 通知アイコンに未読バッジ（赤い丸）が表示されることを確認
4. 「通知」タブをクリック
5. ✅ 「出店申し込みが却下されました」という通知が表示されることを確認
   - タイトル: 「出店申し込みが却下されました」
   - メッセージ: 「[イベント名]への出店申し込みが却下されました。」

---

## 4. 通知機能の詳細確認

### 4-1. 通知一覧の表示

1. 通知タブを開く
2. ✅ 通知が時系列順（新しい順）に表示されることを確認
3. ✅ 未読通知は背景色が異なる（薄い青）ことを確認
4. ✅ 未読通知には緑の丸が表示されることを確認
5. ✅ 既読通知は背景が白であることを確認
6. ✅ イベント名が表示されることを確認
7. ✅ 通知の日時が表示されることを確認（「○分前」「昨日」「○日前」など）

### 4-2. 一括既読機能

1. 通知タブを開く
2. 未読通知がある場合、「すべて既読」ボタンが右上に表示されることを確認
3. 「すべて既読」ボタンをクリック
4. ✅ すべての通知が既読になることを確認（背景色が白に変わる）
5. ✅ 未読バッジが消えることを確認
6. ✅ 「すべて既読」ボタンが消えることを確認

### 4-3. 未読バッジの表示

1. 通知タブを開かずに、ナビゲーションバーの通知アイコンを確認
2. ✅ 未読通知がある場合、通知アイコンの右上に赤い丸（バッジ）が表示されることを確認
3. ✅ バッジには未読数が表示される（9件以上は「9+」）
4. ✅ すべて既読にすると、バッジが消えることを確認

---

## 5. 複数通知の確認

### 5-1. 複数の申し込みを作成

1. **store-web**で複数のアカウント（LINEとメール）でログイン
2. それぞれ異なるイベントに申し込む
3. **organizer-web**で通知を確認
4. ✅ 複数の通知が表示されることを確認
5. ✅ 通知が時系列順に並んでいることを確認

### 5-2. 複数の承認を作成

1. **organizer-web**で複数の申し込みを承認
2. **store-web**で通知を確認
3. ✅ 複数の通知が表示されることを確認

---

## 6. エラーケースの確認

### 6-1. 通知テーブルが存在しない場合

1. Supabaseで`notifications`テーブルを削除（テスト用）
2. イベントに申し込む
3. ✅ 申し込みは成功するが、通知の作成は失敗する（エラーは表示されない）
4. ✅ ブラウザのコンソールにエラーログが表示される

### 6-2. 環境変数が設定されていない場合

1. `SUPABASE_SERVICE_ROLE_KEY`が設定されていない場合
2. 通知の作成に失敗するが、申し込み自体は成功する
3. ✅ ブラウザのコンソールにエラーログが表示される

---

## 確認チェックリスト

### 基本機能
- [ ] 申し込み時の通知（主催者への通知）
- [ ] 承認時の通知（出店者への通知）
- [ ] 却下時の通知（出店者への通知）

### UI機能
- [ ] 通知一覧の表示
- [ ] 未読バッジの表示（ナビゲーションバー）
- [ ] 未読通知の視覚的区別（背景色・緑の丸）
- [ ] 個別既読機能（通知をクリック）
- [ ] 一括既読機能
- [ ] 通知の日時表示

### データ確認
- [ ] 通知が時系列順に表示される
- [ ] イベント名が正しく表示される
- [ ] 通知タイプが正しく表示される

---

## トラブルシューティング

### 通知が表示されない場合

1. **Supabaseで`notifications`テーブルが作成されているか確認**
   - SQL Editorで `SELECT * FROM notifications;` を実行
   - データが存在するか確認

2. **ブラウザのコンソールでエラーを確認**
   - F12キーで開発者ツールを開く
   - Consoleタブでエラーメッセージを確認

3. **ネットワークタブでAPIリクエストを確認**
   - Networkタブで `/api/notifications/create` のリクエストを確認
   - ステータスコードが200か確認

4. **SupabaseのRLSポリシーを確認**
   - `notifications`テーブルのRLSポリシーが正しく設定されているか確認

### 未読バッジが表示されない場合

1. **通知が実際に未読か確認**
   - Supabaseで `SELECT * FROM notifications WHERE is_read = false;` を実行

2. **ブラウザのコンソールでエラーを確認**
   - 未読数取得のAPIリクエストが成功しているか確認

3. **30秒待って自動更新されるか確認**
   - 未読数は30秒ごとに自動更新されます

### 通知が重複して表示される場合

1. **Supabaseで通知データを確認**
   - `SELECT * FROM notifications ORDER BY created_at DESC;` を実行
   - 重複データが存在するか確認

---

## パスワードリセット機能について

パスワードリセット機能は実装済みですが、Supabaseのメール送信制限によりテストできません。

**実装状況：**
- ✅ パスワードリセットページ（メールアドレス入力）
- ✅ パスワード更新ページ（新しいパスワード設定）
- ✅ メールログインフォームに「パスワードを忘れた場合」リンク

**テスト方法（環境変数設定後）：**
1. `RESEND_API_KEY`と`RESEND_FROM_EMAIL`を設定
2. パスワードリセットページでメールアドレスを入力
3. Resend経由でメールが送信される

