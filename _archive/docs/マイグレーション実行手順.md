# データベースマイグレーション実行手順

## 概要
主催者向けアプリをLIFFから通常のWebサイトに移行するためのデータベースマイグレーションです。

## 実行方法

### 方法1: Supabaseダッシュボードで実行（推奨）

1. **Supabaseダッシュボードにアクセス**
   - https://app.supabase.com にログイン
   - 該当するプロジェクトを選択

2. **SQL Editorを開く**
   - 左側メニューから「SQL Editor」を選択
   - 「New query」をクリック

3. **SQLファイルの内容をコピー**
   - `organizer_migration_to_web.sql` の内容をすべてコピー

4. **SQLを実行**
   - SQL Editorに貼り付け
   - 「Run」ボタンをクリック
   - エラーがないか確認

### 方法2: Supabase CLIで実行（開発環境向け）

```bash
# Supabase CLIがインストールされている場合
supabase db push --file organizer_migration_to_web.sql
```

## 実行後の確認

1. **organizersテーブルの確認**
   ```sql
   SELECT column_name, data_type, is_nullable
   FROM information_schema.columns
   WHERE table_name = 'organizers'
   ORDER BY ordinal_position;
   ```
   - `user_id`カラムが追加されていることを確認

2. **インデックスの確認**
   ```sql
   SELECT indexname, indexdef
   FROM pg_indexes
   WHERE tablename = 'organizers';
   ```
   - `idx_organizers_user_id`と`idx_organizers_user_id_unique`が作成されていることを確認

3. **RLSポリシーの確認**
   ```sql
   SELECT policyname, cmd, qual
   FROM pg_policies
   WHERE tablename = 'organizers';
   ```
   - `Users can view their own data`ポリシーが`user_id`を使用していることを確認

## 注意事項

⚠️ **重要**: このマイグレーションを実行する前に、必ずデータベースのバックアップを取得してください。

- 既存のLIFFユーザーは、新規登録時にSupabase Authでアカウントを作成する必要があります
- `line_user_id`カラムは現時点では保持されます（後で削除可能）
- 既存データの移行は手動で行う必要があります

## トラブルシューティング

### エラー: "column already exists"
- `user_id`カラムが既に存在する場合は、このエラーは無視して問題ありません

### エラー: "policy already exists"
- 既存のポリシーを削除してから再実行してください

### エラー: "permission denied"
- Supabaseの管理者権限で実行しているか確認してください




