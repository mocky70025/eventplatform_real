# メールアドレス・パスワード認証追加手順

## 概要

LINE Loginに加えて、メールアドレス・パスワード認証を追加しました。Supabase Authを使用して実装しています。

## 実装内容

### 1. データベーススキーマの更新

`exhibitors`と`organizers`テーブルに`user_id`カラム（Supabase AuthのユーザーID）を追加しました。

**実行するSQL:**
```sql
-- supabase_email_auth_migration.sql を実行
```

このSQLは以下を実行します：
- `exhibitors`テーブルに`user_id`カラムを追加
- `organizers`テーブルに`user_id`カラムを追加
- インデックスの追加
- RLSポリシーの更新（`user_id`または`line_user_id`でアクセス可能）

### 2. 出店者アプリ（store）の変更

#### 変更ファイル
- `store/components/WelcomeScreen.tsx` - ログイン方法の選択UIを追加
- `store/app/page.tsx` - メールアドレス・パスワード認証のセッション確認を追加
- `store/lib/supabase.ts` - セッション管理を有効化、`Exhibitor`型に`user_id`を追加
- `store/components/RegistrationForm.tsx` - 登録時に`user_id`または`line_user_id`を設定
- `store/components/ExhibitorProfile.tsx` - `user_id`または`line_user_id`で検索
- `store/components/ExhibitorEditForm.tsx` - `user_id`または`line_user_id`で更新
- `store/components/EventCard.tsx` - `user_id`または`line_user_id`で検索
- `store/components/EventList.tsx` - `user_id`または`line_user_id`で検索
- `store/components/ApplicationManagement.tsx` - `user_id`または`line_user_id`で検索

### 3. 主催者アプリ（organizer）の変更

#### 変更ファイル
- `organizer/components/WelcomeScreen.tsx` - ログイン方法の選択UIを追加
- `organizer/app/page.tsx` - メールアドレス・パスワード認証のセッション確認を追加
- `organizer/lib/supabase.ts` - セッション管理を有効化
- `organizer/components/RegistrationForm.tsx` - 登録時に`user_id`または`line_user_id`を設定
- `organizer/components/OrganizerProfile.tsx` - `user_id`または`line_user_id`で検索
- `organizer/components/OrganizerEditForm.tsx` - `user_id`または`line_user_id`で更新
- `organizer/components/EventManagement.tsx` - `user_id`または`line_user_id`で検索

## 使用方法

### ログイン方法の選択

1. **LINEでログイン** - 既存のLINE Loginを使用
2. **メールアドレスでログイン** - メールアドレス・パスワードでログイン
3. **新規登録** - メールアドレス・パスワードで新規登録

### 認証フロー

#### メールアドレス・パスワード認証の場合

1. ユーザーがメールアドレス・パスワードでログイン/登録
2. Supabase Authでセッションが作成される
3. `user_id`（Supabase AuthのUUID）が`exhibitors`/`organizers`テーブルに保存される
4. 以降の操作は`user_id`でユーザーを識別

#### LINE Loginの場合（既存）

1. ユーザーがLINE Loginでログイン
2. `line_user_id`が`exhibitors`/`organizers`テーブルに保存される
3. 以降の操作は`line_user_id`でユーザーを識別

## セットアップ手順

### 1. データベースマイグレーション

SupabaseのSQL Editorで以下を実行：

```sql
-- supabase_email_auth_migration.sql を実行
```

### 2. Supabase Authの設定確認

Supabase Dashboardで以下を確認：

1. **Authentication > Providers > Email** が有効になっているか
2. **Authentication > Settings > Email Templates** の設定を確認（必要に応じて）

### 3. 環境変数の確認

既存の環境変数で問題ありません。追加の環境変数は不要です。

## 注意事項

### 既存ユーザーへの影響

- 既存のLINE Loginユーザーは`line_user_id`で識別されるため、影響はありません
- 新規のメールアドレス・パスワードユーザーは`user_id`で識別されます

### セキュリティ

- パスワードはSupabase Authでハッシュ化されて保存されます
- 最小パスワード長は6文字です（Supabaseのデフォルト）
- 必要に応じて、パスワードポリシーを強化できます

### メール確認

Supabase Authのデフォルト設定では、メール確認は不要です。必要に応じて、Supabase Dashboardで有効化できます。

## トラブルシューティング

### ログインできない場合

1. Supabase DashboardでEmail Providerが有効になっているか確認
2. ブラウザのコンソールでエラーメッセージを確認
3. Supabase Authのセッションが正しく作成されているか確認

### 登録できない場合

1. パスワードが6文字以上か確認
2. メールアドレスの形式が正しいか確認
3. 既に登録済みのメールアドレスでないか確認

## 今後の改善案

- [ ] パスワードリセット機能
- [ ] メール確認機能
- [ ] 二要素認証（2FA）
- [ ] ソーシャルログイン（Google、Facebookなど）の追加

