# スプレッドシート機能動作確認手順

## 概要
イベントの申し込み締め切り時に、出店者情報をGoogleスプレッドシートにエクスポートする機能の動作確認手順です。

---

## 前提条件の確認

### 1. 環境変数の確認
以下の環境変数が設定されているか確認してください：

- [ ] `GOOGLE_SERVICE_ACCOUNT_EMAIL` - Googleサービスアカウントのメールアドレス
- [ ] `GOOGLE_PRIVATE_KEY` - Googleサービスアカウントの秘密鍵（改行文字を含む完全な値）
- [ ] `GOOGLE_SPREADSHEET_ID` - GoogleスプレッドシートのID
- [ ] `RESEND_API_KEY` - Resend APIキー（メール送信用、オプショナル）
- [ ] `RESEND_FROM_EMAIL` - 送信元メールアドレス（オプショナル）
- [ ] `NEXT_PUBLIC_APP_URL` - アプリケーションのURL（API呼び出し用）

### 2. Google Sheets APIの設定確認
- [ ] Google Sheets APIが有効化されている
- [ ] サービスアカウントが作成されている
- [ ] サービスアカウントにスプレッドシートの共有権限（編集者）が付与されている

---

## 動作確認手順

### ステップ1: テスト用イベントと申し込みデータの準備

1. **主催者アカウントでログイン**
   - 主催者として登録済みのアカウントでログイン

2. **テスト用イベントを作成**
   - イベント管理画面で新しいイベントを作成
   - イベント名を記録（例: `テストイベント_2025-12-01`）

3. **テスト用申し込みデータを作成**
   - 出店者アカウントでログイン
   - 作成したイベントに申し込み
   - 複数の申し込みを作成（最低2-3件推奨）

### ステップ2: 申し込み締め切り機能のテスト

1. **主催者アカウントでイベント管理画面を開く**
   - 作成したイベントの「申し込み管理」画面を開く

2. **申し込み締め切りボタンをクリック**
   - 「申し込みを締め切る」ボタンをクリック
   - 確認ダイアログで「OK」をクリック

3. **処理結果の確認**
   - アラートメッセージが表示されることを確認
   - 以下の情報が表示されることを確認：
     - 出店者数
     - スプレッドシートURL

### ステップ3: Googleスプレッドシートの確認

1. **スプレッドシートを開く**
   - アラートメッセージに表示されたスプレッドシートURLをクリック
   - または、Googleスプレッドシートに直接アクセス

2. **新しいシートが作成されていることを確認**
   - シート名が `イベント名_YYYY-MM-DD` の形式になっている
   - 例: `テストイベント_2025-12-01_2025-12-01`

3. **データが正しくエクスポートされていることを確認**
   - ヘッダー行が正しく表示されている：
     - 申し込みID
     - 出店者ID
     - 出店者名
     - 性別
     - 年齢
     - 電話番号
     - メールアドレス
     - ジャンルカテゴリ
     - ジャンル自由回答
     - 営業許可証画像URL
     - 車検証画像URL
     - 自動車検査証画像URL
     - PL保険画像URL
     - 火器類配置図画像URL
     - 申し込みステータス
     - 申し込み日時
     - 登録日時
   - データ行が正しく表示されている：
     - 申し込み数分の行が存在する
     - 各フィールドの値が正しく表示されている

### ステップ4: メール送信の確認

1. **主催者のメールボックスを確認**
   - メールが送信されていることを確認
   - 件名: `【イベント名】出店者情報がスプレッドシートにエクスポートされました`
   - 本文にスプレッドシートのリンクが含まれていることを確認

2. **メール送信が失敗している場合**
   - ブラウザのコンソールを確認
   - サーバーログを確認
   - `RESEND_API_KEY`が設定されているか確認

---

## APIエンドポイントの個別テスト

### 1. close-application APIのテスト

```bash
curl -X POST https://your-app-url/api/events/close-application \
  -H "Content-Type: application/json" \
  -d '{
    "eventId": "イベントID",
    "organizerId": "主催者ID"
  }'
```

**期待されるレスポンス:**
```json
{
  "success": true,
  "closedAt": "2025-12-01T12:00:00Z",
  "applications": [...]
}
```

### 2. export-to-sheets APIのテスト

```bash
curl -X POST https://your-app-url/api/events/export-to-sheets \
  -H "Content-Type: application/json" \
  -d '{
    "eventId": "イベントID",
    "eventName": "テストイベント",
    "applications": [...]
  }'
```

**期待されるレスポンス:**
```json
{
  "success": true,
  "spreadsheetUrl": "https://docs.google.com/spreadsheets/d/...",
  "sheetId": 1234567890,
  "sheetTitle": "テストイベント_2025-12-01",
  "rowCount": 3
}
```

### 3. send-sheets-email APIのテスト

```bash
curl -X POST https://your-app-url/api/events/send-sheets-email \
  -H "Content-Type: application/json" \
  -d '{
    "organizerEmail": "organizer@example.com",
    "eventName": "テストイベント",
    "spreadsheetUrl": "https://docs.google.com/spreadsheets/d/..."
  }'
```

**期待されるレスポンス:**
```json
{
  "success": true,
  "message": "Email sent successfully via Resend",
  "email": "organizer@example.com",
  "spreadsheetUrl": "https://docs.google.com/spreadsheets/d/...",
  "emailId": "email-id"
}
```

### 4. close-and-export APIのテスト（一括実行）

```bash
curl -X POST https://your-app-url/api/events/close-and-export \
  -H "Content-Type: application/json" \
  -d '{
    "eventId": "イベントID",
    "organizerId": "主催者ID",
    "eventName": "テストイベント",
    "organizerEmail": "organizer@example.com"
  }'
```

**期待されるレスポンス:**
```json
{
  "success": true,
  "eventId": "イベントID",
  "closedAt": "2025-12-01T12:00:00Z",
  "spreadsheetUrl": "https://docs.google.com/spreadsheets/d/...",
  "sheetId": 1234567890,
  "sheetTitle": "テストイベント_2025-12-01",
  "applicationCount": 3,
  "emailSent": true
}
```

---

## トラブルシューティング

### エラー: "Google Sheets API is not configured"
- 環境変数が設定されているか確認
- 特に`GOOGLE_SERVICE_ACCOUNT_EMAIL`、`GOOGLE_PRIVATE_KEY`、`GOOGLE_SPREADSHEET_ID`が設定されているか確認

### エラー: "Permission denied"
- サービスアカウントにスプレッドシートの共有権限が付与されているか確認
- サービスアカウントのメールアドレス（`client_email`）が正しいか確認

### エラー: "Spreadsheet not found"
- `GOOGLE_SPREADSHEET_ID`が正しいか確認
- スプレッドシートのURLからIDを正しく取得できているか確認

### エラー: "Failed to close application"
- `close-application` APIが正しく動作しているか確認
- イベントIDと主催者IDが正しいか確認

### エラー: "Failed to export to Google Sheets"
- Google Sheets APIの認証情報が正しいか確認
- サービスアカウントにスプレッドシートの共有権限が付与されているか確認

### メールが送信されない
- `RESEND_API_KEY`が設定されているか確認
- `RESEND_FROM_EMAIL`が設定されているか確認
- Resendのドメイン認証が完了しているか確認

---

## 確認チェックリスト

動作確認が完了したら、以下をチェックしてください：

- [ ] 環境変数がすべて設定されている
- [ ] Google Sheets APIが有効化されている
- [ ] サービスアカウントにスプレッドシートの共有権限が付与されている
- [ ] 申し込み締め切りボタンが正常に動作する
- [ ] スプレッドシートに新しいシートが作成される
- [ ] データが正しくエクスポートされる
- [ ] メールが正常に送信される（設定されている場合）
- [ ] エラーハンドリングが適切に動作する

---

## 次のステップ

動作確認が完了したら、本番環境でのテストを行ってください。



