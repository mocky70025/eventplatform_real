# 本番環境セットアップ手順（LINE Login）

## 概要

本番環境では、出店者アプリ（store）と主催者アプリ（organizer）で**別々のLINE Loginチャネル**を使用します。
これにより、それぞれ独立したコールバックURLを設定でき、シンプルで保守しやすい実装になります。

## 前提条件

- 本番環境のURLが決まっている
  - store側: `https://tomorrow-event-platform-store.vercel.app`
  - organizer側: `https://tomorrow-event-platform-organizer.vercel.app`
- HTTPSが有効になっている
- LINE DevelopersでLINEログインチャネルを2つ作成済み（出店者用と主催者用）

---

## ステップ1: LINE Developersでチャネルを作成

### 1. 出店者用チャネル（作成済み）

- **チャネルID**: `2008516155`
- **チャネルシークレット**: `4b6ca4be9c0ae7e856bb4db72c777876`

### 2. 主催者用チャネル（作成済み）

- **チャネルID**: `2008522999`
- **チャネルシークレット**: `0ed1ef5ae23d6c27073df952991080cd`

---

## ステップ2: 環境変数を設定

### store側（出店者アプリ）

Vercelの環境変数に以下を設定：

```env
# Supabase設定
NEXT_PUBLIC_SUPABASE_URL=https://xszkbfwqtwpsfnwdfjak.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzemtiZndxdHdwc2Zud2RmamFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODQ4MTUsImV4cCI6MjA3ODk2MDgxNX0.cwNetSFLWu4A8VY7-B6MjriD-8KI9L4NXIE1rxvf95Q

# LINE Login設定（出店者用チャネル）
NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID=2008516155
LINE_LOGIN_CHANNEL_SECRET=4b6ca4be9c0ae7e856bb4db72c777876
NEXT_PUBLIC_LINE_LOGIN_REDIRECT_URI=https://tomorrow-event-platform-store.vercel.app/auth/callback
NEXT_PUBLIC_APP_URL=https://tomorrow-event-platform-store.vercel.app
```

### organizer側（主催者アプリ）

Vercelの環境変数に以下を設定：

```env
# Supabase設定
NEXT_PUBLIC_SUPABASE_URL=https://xszkbfwqtwpsfnwdfjak.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzemtiZndxdHdwc2Zud2RmamFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODQ4MTUsImV4cCI6MjA3ODk2MDgxNX0.cwNetSFLWu4A8VY7-B6MjriD-8KI9L4NXIE1rxvf95Q

# LINE Login設定（主催者用チャネル）
NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID=2008522999
LINE_LOGIN_CHANNEL_SECRET=0ed1ef5ae23d6c27073df952991080cd
NEXT_PUBLIC_LINE_LOGIN_REDIRECT_URI=https://tomorrow-event-platform-organizer.vercel.app/auth/callback
NEXT_PUBLIC_APP_URL=https://tomorrow-event-platform-organizer.vercel.app
```

**⚠️ 重要**: 
- store側とorganizer側で**異なるLINEログインチャネルID**を使用します
- それぞれのチャネルで、対応するコールバックURLを設定します

---

## ステップ3: LINE DevelopersでコールバックURLを設定

### 出店者用チャネル

1. LINE Developers Consoleで出店者用チャネルを開く
2. 「LINEログイン設定」タブを開く
3. 「コールバックURL」に以下を追加：
   ```
   https://tomorrow-event-platform-store.vercel.app/auth/callback
   ```
4. 「スコープ」で以下を選択：
   - `profile`
   - `openid`
   - `email`
5. 「保存」をクリック

### 主催者用チャネル

1. LINE Developers Consoleで主催者用チャネルを開く
2. 「LINEログイン設定」タブを開く
3. 「コールバックURL」に以下を追加：
   ```
   https://tomorrow-event-platform-organizer.vercel.app/auth/callback
   ```
4. 「スコープ」で以下を選択：
   - `profile`
   - `openid`
   - `email`
5. 「保存」をクリック

---

## ステップ4: データベースマイグレーション

### store側（出店者アプリ）

`exhibitors`テーブルは既に`line_user_id`カラムがあることを確認してください。

### organizer側（主催者アプリ）

`organizer_migration_to_line_login_simple.sql` を実行してください：

1. Supabaseダッシュボードを開く
2. SQL Editorを開く
3. `organizer_migration_to_line_login_simple.sql` の内容をコピーして実行

---

## ステップ5: デプロイ

### Vercelの場合

1. GitHubにプッシュ
2. Vercelでデプロイ
3. 環境変数を設定（Vercelのダッシュボードで）
   - store側とorganizer側でそれぞれ異なるチャネルID/Secretを設定

---

## ステップ6: 動作確認

### 事前確認

1. **Vercelの環境変数が正しく設定されているか確認**
   - store側とorganizer側で、それぞれ異なるチャネルID/Secretが設定されているか
   - コールバックURLが正しく設定されているか

2. **LINE DevelopersでコールバックURLが設定されているか確認**
   - 出店者用チャネル（2008516155）: `https://tomorrow-event-platform-store.vercel.app/auth/callback`
   - 主催者用チャネル（2008522999）: `https://tomorrow-event-platform-organizer.vercel.app/auth/callback`

3. **Vercelで再デプロイが完了しているか確認**
   - 環境変数を変更した場合は、再デプロイが必要です

---

### 1. store側（出店者アプリ）の確認

1. **ブラウザで開く**
   - `https://tomorrow-event-platform-store.vercel.app` にアクセス

2. **開発者ツールを開く**
   - F12キーを押して開発者ツールを開く
   - 「Console」タブを開く（エラー確認用）

3. **LINEログインを実行**
   - 「LINEでログイン」ボタンをクリック
   - LINEログイン画面が表示されることを確認
   - LINEアカウントでログイン

4. **コールバック後の確認**
   - コールバック後、出店者向けの登録フォームが表示されることを確認 ✅
   - フォームに以下のフィールドがあることを確認：
     - 名前
     - 性別
     - 年齢
     - 電話番号
     - メールアドレス
     - **注意**: 「会社名」フィールドは**ない**はずです（出店者向けなので）

5. **コンソールでエラーがないか確認**
   - エラーメッセージが表示されていないか確認
   - `[LINE Login] App Type: store` が表示されているか確認

---

### 2. organizer側（主催者アプリ）の確認

1. **ブラウザで開く**
   - `https://tomorrow-event-platform-organizer.vercel.app` にアクセス

2. **開発者ツールを開く**
   - F12キーを押して開発者ツールを開く
   - 「Console」タブを開く（エラー確認用）

3. **LINEログインを実行**
   - 「LINEでログイン」ボタンをクリック
   - LINEログイン画面が表示されることを確認
   - LINEアカウントでログイン

4. **コールバック後の確認**
   - コールバック後、主催者向けの登録フォームが表示されることを確認 ✅
   - フォームに以下のフィールドがあることを確認：
     - **会社名** ← これが主催者向けの特徴
     - 名前
     - 性別
     - 年齢
     - 電話番号
     - メールアドレス

5. **コンソールでエラーがないか確認**
   - エラーメッセージが表示されていないか確認
   - `[Callback] App type: organizer` が表示されているか確認

---

### 確認ポイント

#### ✅ 正常な動作

- store側でログイン → 出店者向けフォーム（会社名なし）が表示される
- organizer側でログイン → 主催者向けフォーム（会社名あり）が表示される
- コンソールにエラーが表示されない
- リダイレクト処理が発生しない（直接コールバックされる）

#### ❌ 問題がある場合

- **出店者向けフォームに「会社名」が表示される**
  - → organizer側のチャネルIDがstore側に設定されている可能性
  - → Vercelの環境変数を確認

- **主催者向けフォームに「会社名」が表示されない**
  - → store側のチャネルIDがorganizer側に設定されている可能性
  - → Vercelの環境変数を確認

- **コールバックURLエラーが表示される**
  - → LINE DevelopersでコールバックURLが正しく設定されているか確認
  - → 環境変数の`NEXT_PUBLIC_LINE_LOGIN_REDIRECT_URI`が正しいか確認

- **「認証コードが取得できませんでした」エラー**
  - → LINE DevelopersでコールバックURLが正しく設定されているか確認
  - → スコープ（profile, openid, email）が選択されているか確認

- **「400 Bad Request: This channel is now developing status. User need to have developer role.」エラー**
  - → チャネルが開発ステータスになっているため、テストユーザーを追加する必要があります
  - → 解決方法：
    1. LINE Developers Consoleで該当チャネルを開く
    2. 「LINEログイン設定」タブを開く
    3. 「テストユーザー」セクションで、使用するLINEアカウントを追加
    4. または、「チャネルステータス」を「本番」に変更（本番環境の場合）
  - → テストユーザーを追加した後、ブラウザのキャッシュをクリアして再試行

---

## 重要なポイント

### ✅ チャネルを分けるメリット

1. **シンプルな実装**
   - リダイレクト処理が不要
   - コールバック処理が単純化

2. **保守性の向上**
   - デバッグが容易
   - エラー原因の特定が簡単

3. **独立性**
   - 出店者側と主催者側で独立して設定変更可能
   - 片方に影響を与えずに設定変更可能

4. **セキュリティ**
   - チャネルを分離できる
   - 権限管理が明確

---

## トラブルシューティング

### コールバックURLが正しく設定されていない場合

- LINE Developers Consoleで、各チャネルのコールバックURLを確認
- 環境変数の`NEXT_PUBLIC_LINE_LOGIN_REDIRECT_URI`が正しく設定されているか確認

### チャネルID/Secretが間違っている場合

- Vercelの環境変数を確認
- store側とorganizer側で異なるチャネルID/Secretを使用しているか確認

### フォームが正しく表示されない場合

- ブラウザのコンソール（F12）でエラーを確認
- セッションストレージにプロフィール情報が保存されているか確認

---

## 完了チェックリスト

- [ ] LINE Developersで出店者用チャネルを作成
- [ ] LINE Developersで主催者用チャネルを作成
- [ ] store側の環境変数を設定（出店者用チャネルID/Secret）
- [ ] organizer側の環境変数を設定（主催者用チャネルID/Secret）
- [ ] 出店者用チャネルにコールバックURLを設定
- [ ] 主催者用チャネルにコールバックURLを設定
- [ ] データベースマイグレーションを実行
- [ ] 本番環境にデプロイ
- [ ] store側で動作確認（出店者向けフォームが表示される）
- [ ] organizer側で動作確認（主催者向けフォームが表示される）

---

## まとめ

本番環境では、出店者アプリと主催者アプリで**別々のLINE Loginチャネル**を使用します。
これにより、それぞれ独立したコールバックURLを設定でき、シンプルで保守しやすい実装になります。
