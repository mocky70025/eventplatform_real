# organizer側（主催者アプリ）本番環境セットアップ手順

## 概要

organizer側（主催者アプリ）を本番環境（Vercel）にデプロイし、LINE Login（OAuth）を使用できるようにするためのセットアップ手順です。
store側と**同じLINEログインチャネルID**を使用することで、**確実に同じユーザーID**を取得できます。

## 前提条件

- 本番環境のURLが決まっている（例: `https://tomorrow-event-platform-organizer.vercel.app`）
- HTTPSが有効になっている
- LINE DevelopersでLINEログインチャネルを作成済み
- store側と同じLINEログインチャネルIDを使用する

---

## ステップ1: 環境変数を設定

### Vercelの環境変数設定

Vercelのダッシュボードで、organizer側のプロジェクトを開き、「Settings」→「Environment Variables」で以下を設定：

```env
# Supabase設定
NEXT_PUBLIC_SUPABASE_URL=https://wosgrdgnkdaxmykclazc.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indvc2dyZGdua2RheG15a2NsYXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjU4OTksImV4cCI6MjA3ODkwMTg5OX0.tAB-e53Xf8Lif8yzpJCoXsmnKM_oTAiVEMbETo4ivSg

# LINE Login設定
NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID=2008516155
LINE_LOGIN_CHANNEL_SECRET=4b6ca4be9c0ae7e856bb4db72c777876
NEXT_PUBLIC_LINE_LOGIN_REDIRECT_URI=https://tomorrow-event-platform-organizer.vercel.app/auth/callback
NEXT_PUBLIC_APP_URL=https://tomorrow-event-platform-organizer.vercel.app
```

**⚠️ 重要**: 
- `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID` は、store側と同じチャネルIDを使用してください
- これにより、確実に同じユーザーIDが取得できます
- `LINE_LOGIN_CHANNEL_SECRET` は機密情報のため、環境変数として設定してください（クライアントサイドに公開されません）

---

## ステップ2: LINE Developersで設定

### 2-1. コールバックURLを設定

LINE Developers Consoleで、使用しているLINEログインチャネルの設定画面を開き、「LINEログイン設定」タブで以下を追加：

**organizer側（主催者アプリ）**:
```
https://tomorrow-event-platform-organizer.vercel.app/auth/callback
```

**store側（出店者アプリ）**（既に設定済みの場合）:
```
https://tomorrow-event-platform-store.vercel.app/auth/callback
```

**✅ 確認ポイント**: 
- store側とorganizer側で**同じLINEログインチャネル**を使用していることを確認
- コールバックURLが両方追加されていることを確認

### 2-2. LIFFアプリの設定（オプション）

organizer側用のLIFFアプリも必要であれば追加できます：

1. 同じLINEログインチャネルの「LIFF」タブを開く
2. 「LIFFアプリを追加」をクリック
3. 以下の情報を入力：
   - **アプリ名**: 任意の名前（例: "主催者アプリ"）
   - **エンドポイントURL**: `https://tomorrow-event-platform-organizer.vercel.app`（organizer側の本番URL）
   - **サイズ**: Full（推奨）
   - **スコープ**: `profile openid email`

**⚠️ 注意**: 
- LIFFアプリはオプションです。現在の実装では、LIFF環境でもWeb環境でもLINE Login（OAuth）を使用します
- LIFFアプリを作成する場合は、エンドポイントURLをorganizer側の本番URLに設定してください

---

## ステップ3: データベースマイグレーション

### organizersテーブルの確認

Supabaseダッシュボードで、`organizers`テーブルに`line_user_id`カラムが存在することを確認してください。

### マイグレーションの実行（未実行の場合）

`organizer_migration_to_line_login_simple.sql` を実行してください：

1. Supabaseダッシュボードを開く
2. SQL Editorを開く
3. `organizer_migration_to_line_login_simple.sql` の内容をコピーして実行

**確認SQL**:
```sql
-- organizersテーブルのカラムを確認
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'organizers'
ORDER BY ordinal_position;
```

`line_user_id`カラムが存在することを確認してください。

---

## ステップ4: Vercelにデプロイ

### 4-1. GitHubにプッシュ

```bash
git add .
git commit -m "organizer側の本番環境設定を追加"
git push origin main
```

### 4-2. Vercelでデプロイ

1. Vercelダッシュボードを開く
2. organizer側のプロジェクトを選択
3. 最新のコミットが自動的にデプロイされることを確認
4. デプロイが完了するまで待つ

### 4-3. 環境変数の確認

デプロイ後、環境変数が正しく設定されているか確認：

1. Vercelダッシュボードで「Settings」→「Environment Variables」を開く
2. すべての環境変数が設定されていることを確認
3. 必要に応じて、デプロイを再実行

---

## ステップ5: 動作確認

### 5-1. Web環境での確認

1. **organizer側**: `https://tomorrow-event-platform-organizer.vercel.app` を開く
2. ブラウザの開発者ツール（DevTools）を開く（F12 または Cmd+Option+I）
3. 「Console」タブを選択
4. 「LINEでログイン」ボタンをクリック
5. LINEログイン画面で認証
6. コールバック後、コンソールに以下のログが表示されることを確認：
   ```
   [LINE Login] User ID: U1234567890abcdef...
   [LINE Login] Display Name: あなたの名前
   ```
7. ユーザーIDをメモ

### 5-2. store側とのユーザーID一致確認

1. **store側**: `https://tomorrow-event-platform-store.vercel.app` を開く
2. LINEログインを実行
3. ユーザーIDをメモ

4. **確認**: organizer側とstore側で同じユーザーIDが取得できることを確認 ✅

### 5-3. LIFF環境での確認（オプション）

1. LINEアプリでLIFF URLを開く（LIFFアプリを作成した場合）
2. LINEログインを実行
3. ユーザーIDをメモ

4. **確認**: Web環境と同じユーザーIDが取得できることを確認 ✅

---

## 重要なポイント

### ✅ 確実に同じユーザーIDを取得する方法

1. **同じLINEログインチャネルIDを使用**
   - organizer側とstore側で同じチャネルIDを使用
   - これにより、確実に同じユーザーIDが取得できます

2. **LIFF環境でもLINE Login（OAuth）を使用**
   - 実装では、LIFF環境でもWeb環境でもLINE Login（OAuth）を使用
   - 同じチャネルIDを使用することで、確実に同じユーザーIDが取得できます

3. **本番環境ではHTTPSが必須**
   - LIFF環境ではHTTPSが必要
   - 本番環境では通常HTTPSが使えるので問題ありません

---

## トラブルシューティング

### エラー: `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID is not set`

- Vercelの環境変数が正しく設定されているか確認
- 環境変数の名前が正しいか確認（`NEXT_PUBLIC_` プレフィックスが必要）
- デプロイを再実行

### エラー: `Failed to exchange code for token`

- `LINE_LOGIN_CHANNEL_SECRET` が正しく設定されているか確認
- コールバックURLが正しく設定されているか確認
- LINE Developersの設定を再確認

### ユーザーIDが一致しない場合

- organizer側とstore側で同じLINEログインチャネルIDを使用しているか確認
- 環境変数が正しく設定されているか確認
- LINE Developersの設定を再確認

### コールバック後にエラーが出る場合

- ブラウザのコンソールでエラー内容を確認
- データベースの`organizers`テーブルに`line_user_id`カラムが追加されているか確認
- Supabaseのログを確認

### LIFF環境でエラーが出る場合

- LIFFアプリのエンドポイントURLが正しく設定されているか確認
- HTTPSが有効になっているか確認
- LINE Developersの設定を再確認

---

## 完了チェックリスト

- [ ] Vercelの環境変数を設定
- [ ] LINE DevelopersでコールバックURLを設定（organizer側）
- [ ] LINE DevelopersでLIFFアプリを作成（オプション）
- [ ] データベースマイグレーションを実行（`line_user_id`カラムの確認）
- [ ] Vercelにデプロイ
- [ ] Web環境で動作確認
- [ ] store側とorganizer側で同じユーザーIDが取得できることを確認
- [ ] LIFF環境で動作確認（オプション）

---

## まとめ

organizer側（主催者アプリ）を本番環境にデプロイし、LINE Login（OAuth）を使用できるようにしました。
store側と同じLINEログインチャネルIDを使用することで、**確実に同じユーザーID**を取得できます。

これにより、同じLINEアカウントで出店者と主催者の両方の機能を使用できるようになります。

---

## 関連ファイル

- `本番環境セットアップ手順.md` - store側とorganizer側の両方のセットアップ手順
- `organizer_migration_to_line_login_simple.sql` - データベースマイグレーションSQL
- `organizer/次のステップ.md` - 開発環境用のセットアップ手順


