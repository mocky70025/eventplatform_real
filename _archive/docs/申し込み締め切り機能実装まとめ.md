# 申し込み締め切り機能実装まとめ

## 実装した機能

### 1. データベースの拡張
- `events`テーブルに`is_application_closed`カラムを追加（申し込み締め切り状態）
- `events`テーブルに`application_closed_at`カラムを追加（締め切り日時）
- ファイル: `supabase_events_application_closed.sql`

### 2. APIエンドポイント

#### `/api/events/close-application` (POST)
- イベントの申し込みを締め切る
- 申し込んだ出店者の情報を取得
- レスポンス: 申し込みデータの配列

#### `/api/events/export-to-sheets` (POST)
- 出店者情報をGoogleスプレッドシートにエクスポート
- 新しいシートを作成（イベント名と日時を含む）
- レスポンス: スプレッドシートのURL

#### `/api/events/send-sheets-email` (POST)
- 主催者にスプレッドシートのリンクをメール送信
- 現在はログ出力のみ（メール送信機能は後で実装）

#### `/api/events/close-and-export` (POST)
- 申し込み締め切り、Google Sheetsへのエクスポート、メール送信を一括で実行
- 上記3つのAPIを順番に呼び出す

#### `/api/events/applicants` (GET)
- イベントに申し込んだ出店者の情報を取得
- 主催者アプリ内で閲覧するために使用

---

## 必要な環境変数

### Vercel（organizer-webプロジェクト）

1. **GOOGLE_SERVICE_ACCOUNT_EMAIL**
   - Googleサービスアカウントのメールアドレス

2. **GOOGLE_PRIVATE_KEY**
   - Googleサービスアカウントの秘密鍵（改行文字を含む）

3. **GOOGLE_SPREADSHEET_ID**
   - GoogleスプレッドシートのID

4. **SUPABASE_SERVICE_ROLE_KEY**
   - Supabaseのサービスロールキー（RLSをバイパスするために必要）

---

## 実装手順

### ステップ1: データベースの拡張
1. Supabase Dashboard > SQL Editorを開く
2. `supabase_events_application_closed.sql`を実行

### ステップ2: Google Sheets APIの設定
1. `Google_Sheets_API設定手順.md`を参照
2. Google Cloud Consoleでプロジェクト作成
3. Google Sheets APIを有効化
4. サービスアカウントを作成
5. 認証情報を取得
6. Googleスプレッドシートを作成
7. サービスアカウントに共有権限を付与

### ステップ3: 環境変数の設定
1. Vercel Dashboardで`organizer-web`プロジェクトを選択
2. 「Settings」> 「Environment Variables」を開く
3. 上記4つの環境変数を追加

### ステップ4: パッケージのインストール
```bash
cd organizer
npm install google-spreadsheet google-auth-library
```

### ステップ5: 再デプロイ
1. Vercel Dashboardで再デプロイを実行

---

## 次のステップ（UI実装）

### 1. 申し込み締め切りボタンの追加
- `organizer/components/EventApplications.tsx`に「申し込みを締め切る」ボタンを追加
- `/api/events/close-and-export`を呼び出す

### 2. 出店者情報閲覧画面の実装
- 主催者アプリ内で出店者情報を表示する画面を作成
- `/api/events/applicants`を使用してデータを取得
- 出店者の基本情報と書類（画像）を表示

---

## 注意事項

1. **メール送信機能**
   - 現在はログ出力のみ
   - 実際のメール送信には、Supabase Functionsまたは外部サービス（Resend、SendGrid等）を使用する必要があります

2. **Google Sheets API**
   - サービスアカウントにスプレッドシートの共有権限を付与する必要があります
   - 環境変数`GOOGLE_PRIVATE_KEY`には改行文字を含む完全な値が必要です

3. **セキュリティ**
   - `SUPABASE_SERVICE_ROLE_KEY`は機密情報です。絶対に公開しないでください
   - APIエンドポイントは主催者の認証を確認していますが、追加のセキュリティ対策を検討してください

---

## テスト手順

1. イベントを作成
2. 出店者がイベントに申し込む
3. 主催者が「申し込みを締め切る」ボタンをクリック
4. Googleスプレッドシートにデータがエクスポートされることを確認
5. 主催者のメールアドレスにスプレッドシートのリンクが送信されることを確認（実装後）
6. 主催者アプリ内で出店者情報が閲覧できることを確認（実装後）

