# 動作確認手順（段階的ガイド）

## 📋 準備：必要な情報を確認

動作確認を始める前に、以下を準備してください：
- LINE Developersアカウント（https://developers.line.biz/console/）
- 開発サーバーが起動できる環境（`npm run dev`）

---

## ステップ1: LINE DevelopersでLINEログインチャネルを作成

### 1-1. LINE Developers Consoleにアクセス
1. ブラウザで https://developers.line.biz/console/ を開く
2. LINEアカウントでログイン

### 1-2. プロバイダーの選択または作成
1. 既存のプロバイダーがある場合は選択
2. ない場合は「新規プロバイダー作成」をクリック
   - プロバイダー名を入力（例: "Tomorrow Event Platform"）
   - 作成を完了

### 1-3. LINEログインチャネルの作成
1. プロバイダー画面で「チャネルを追加」をクリック
2. 「LINEログイン」を選択
3. チャネル情報を入力：
   - **チャネル名**: 任意の名前（例: "出店者アプリ"）
   - **チャネル説明**: 任意
   - **アプリタイプ**: 「Webアプリ」を選択
   - **メールアドレス**: 連絡先メールアドレス
   - **利用規約URL**: 任意（開発中は空欄でも可）
   - **プライバシーポリシーURL**: 任意（開発中は空欄でも可）
4. 「作成」をクリック

### 1-4. チャネルIDとチャネルシークレットを確認
1. 作成したチャネルの設定画面を開く
2. 「チャネル基本設定」タブで以下を確認：
   - **Channel ID**: 後で使用します（例: `1234567890`）
   - **Channel Secret**: 後で使用します（「表示」をクリックして確認）

**✅ 確認ポイント**: Channel IDとChannel Secretをメモ帳にコピーしてください

---

## ステップ2: 同じチャネル内にLIFFアプリを追加

### 2-1. LIFFタブを開く
1. 同じLINEログインチャネルの設定画面で「LIFF」タブを選択
2. 「LIFFアプリを追加」をクリック

### 2-2. LIFFアプリの情報を入力
1. **アプリ名**: 任意の名前（例: "出店者アプリ LIFF"）
2. **エンドポイントURL**: 
   - 開発環境: `http://localhost:3001`
   - 本番環境: `https://your-domain.com`
   - ⚠️ 開発中は `http://localhost:3001` を入力
3. **サイズ**: 「Full」を選択
4. **スコープ**: 以下を選択
   - ✅ `profile`
   - ✅ `openid`
   - ✅ `email`
5. 「追加」をクリック

### 2-3. LIFF IDを確認
1. 作成されたLIFFアプリの一覧で、**LIFF ID**を確認
   - 例: `1234567890-abcdefgh`

**✅ 確認ポイント**: LIFF IDをメモ帳にコピーしてください

---

## ステップ3: LINE LoginのコールバックURLを設定

### 3-1. LINEログイン設定タブを開く
1. 同じLINEログインチャネルの設定画面で「LINEログイン設定」タブを選択

### 3-2. コールバックURLを追加
1. 「コールバックURL」セクションで「追加」をクリック
2. 以下のURLを入力：
   ```
   http://localhost:3001/auth/callback
   ```
3. 「追加」をクリック

**✅ 確認ポイント**: コールバックURLが正しく追加されているか確認

---

## ステップ4: 環境変数を設定

### 4-1. `.env.local`ファイルを開く
1. `store/.env.local` ファイルを開く（存在しない場合は作成）

### 4-2. 環境変数を追加
以下の内容を追加または更新してください：

```env
# Supabase設定（既存）
NEXT_PUBLIC_SUPABASE_URL=https://wosgrdgnkdaxmykclazc.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indvc2dyZGdua2RheG15a2NsYXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjU4OTksImV4cCI6MjA3ODkwMTg5OX0.tAB-e53Xf8Lif8yzpJCoXsmnKM_oTAiVEMbETo4ivSg

# LINE LIFF設定（ステップ2-3で取得したLIFF IDを設定）
NEXT_PUBLIC_LIFF_ID=ここにLIFF_IDを貼り付け

# LINE Login設定（ステップ1-4で取得した情報を設定）
NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID=ここにChannel_IDを貼り付け
LINE_LOGIN_CHANNEL_SECRET=ここにChannel_Secretを貼り付け
NEXT_PUBLIC_LINE_LOGIN_REDIRECT_URI=http://localhost:3001/auth/callback
NEXT_PUBLIC_APP_URL=http://localhost:3001
```

**✅ 確認ポイント**: 
- `NEXT_PUBLIC_LIFF_ID` にステップ2-3で取得したLIFF IDを設定
- `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID` にステップ1-4で取得したChannel IDを設定
- `LINE_LOGIN_CHANNEL_SECRET` にステップ1-4で取得したChannel Secretを設定

---

## ステップ5: 開発サーバーを起動

### 5-1. ターミナルでstoreディレクトリに移動
```bash
cd store
```

### 5-2. 開発サーバーを起動
```bash
npm run dev
```

### 5-3. サーバーが起動したことを確認
- ターミナルに `http://localhost:3001` が表示されることを確認
- ブラウザで `http://localhost:3001` を開いてエラーが出ないことを確認

**✅ 確認ポイント**: サーバーが正常に起動していること

---

## ステップ6: Web環境（LINE Login）での動作確認

### 6-1. ブラウザでアプリを開く
1. 通常のWebブラウザ（Chrome推奨）で `http://localhost:3001` を開く
2. 開発者ツール（DevTools）を開く：
   - Windows/Linux: `F12` または `Ctrl+Shift+I`
   - Mac: `Cmd+Option+I`
3. 「Console」タブを選択

### 6-2. 認証モードの確認
1. コンソールに以下のログが表示されることを確認：
   ```
   [Auth] Mode detected: line_login
   ```
   - ✅ `line_login` と表示されていればOK
   - ❌ エラーが出る場合は、環境変数を確認

### 6-3. LINEログインボタンをクリック
1. 画面に「LINEでログイン」ボタンが表示されていることを確認
2. ボタンをクリック

### 6-4. LINEログイン画面で認証
1. LINEログイン画面が表示される
2. LINEアカウントでログイン
3. 権限を許可

### 6-5. コールバック後の確認
1. `http://localhost:3001/auth/callback` にリダイレクトされる
2. コンソールに以下のログが表示されることを確認：
   ```
   [LINE Login] User ID: U1234567890abcdef...
   [LINE Login] Display Name: あなたの名前
   ```
3. **ユーザーIDをメモ帳にコピー**（例: `U1234567890abcdef...`）

**✅ 確認ポイント**: 
- ユーザーIDが取得できていること
- エラーが出ていないこと

---

## ステップ7: LIFF環境での動作確認

### 7-1. LIFF URLを取得
1. LINE Developers Consoleで、作成したLIFFアプリの設定画面を開く
2. 「LIFF URL」をコピー
   - 例: `https://liff.line.me/1234567890-abcdefgh`

### 7-2. LINEアプリでLIFF URLを開く
1. LINEアプリを開く
2. 任意のチャット（自分とのトークでも可）で、LIFF URLを送信
3. LIFF URLをタップして開く

**⚠️ 注意**: LINEアプリ内で開く必要があります。ブラウザでは開けません。

### 7-3. 開発者ツールで確認（可能な場合）
- LINEアプリ内では開発者ツールが開けない場合があります
- 可能な場合は、コンソールに以下のログが表示されることを確認：
  ```
  [Auth] Mode detected: liff
  [LIFF] Initialized, isLoggedIn: true
  [LIFF] User ID: U1234567890abcdef...
  ```

### 7-4. ユーザーIDを確認
1. ログイン後、アプリが正常に動作することを確認
2. **ユーザーIDをメモ帳にコピー**（表示されない場合は、データベースで確認）

**✅ 確認ポイント**: 
- LIFF環境でアプリが正常に動作すること
- ユーザーIDが取得できていること

---

## ステップ8: ユーザーIDの一致確認（最重要）

### 8-1. 取得したユーザーIDを比較
1. ステップ6-5で取得したWeb環境のユーザーID
2. ステップ7-4で取得したLIFF環境のユーザーID

### 8-2. 結果の確認

**✅ 同じユーザーIDの場合**:
- 🎉 **成功！** 同じチャネルIDを使用することで、同じユーザーIDが取得できています
- LIFFとLINE Loginで同じアカウントとして扱われます

**❌ 異なるユーザーIDの場合**:
- ⚠️ チャネル設定を確認してください
- 同じLINEログインチャネル内にLIFFアプリが追加されているか確認
- 同じプロバイダー内のチャネルを使用しているか確認

---

## トラブルシューティング

### エラー: `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID is not set`
- `.env.local` に `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID` が設定されているか確認
- サーバーを再起動してください

### エラー: `Failed to exchange code for token`
- `LINE_LOGIN_CHANNEL_SECRET` が正しく設定されているか確認
- コールバックURLがLINE Developersで正しく設定されているか確認

### LIFF環境でエラーが出る
- `NEXT_PUBLIC_LIFF_ID` が正しく設定されているか確認
- LIFFアプリのエンドポイントURLが正しいか確認
- LINEアプリ内で開いているか確認

### ユーザーIDが一致しない
- 同じLINEログインチャネル内にLIFFアプリが追加されているか確認
- 同じプロバイダー内のチャネルを使用しているか確認

---

## 次のステップ

動作確認が完了したら：
1. ユーザーIDが一致することを確認
2. 本番環境の設定（コールバックURL、エンドポイントURLの更新）
3. セキュリティ対策の追加（IDトークンの署名検証など）



