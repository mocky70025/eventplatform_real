# 動作確認手順（簡易版）

## 🎯 変更点

**重要な変更**: LIFF環境でもWeb環境でも、**常にLINE Login（OAuth）を使用**するようになりました。
これにより、確実に同じユーザーIDが取得できます。

---

## 📋 準備：必要な情報を確認

動作確認を始める前に、以下を準備してください：
- LINE Developersアカウント（https://developers.line.biz/console/）
- 開発サーバーが起動できる環境（`npm run dev`）

---

## ステップ1: LINE DevelopersでLINEログインチャネルを作成

### 1-1. LINE Developers Consoleにアクセス
1. ブラウザで https://developers.line.biz/console/ を開く
2. LINEアカウントでログイン

### 1-2. プロバイダーの選択または作成
1. 既存のプロバイダーがある場合は選択
2. ない場合は「新規プロバイダー作成」をクリック
   - プロバイダー名を入力（例: "Tomorrow Event Platform"）
   - 作成を完了

### 1-3. LINEログインチャネルの作成
1. プロバイダー画面で「チャネルを追加」をクリック
2. 「LINEログイン」を選択
3. チャネル情報を入力：
   - **チャネル名**: 任意の名前（例: "出店者アプリ"）
   - **チャネル説明**: 任意
   - **アプリタイプ**: 「Webアプリ」を選択
   - **メールアドレス**: 連絡先メールアドレス
   - **利用規約URL**: 任意（開発中は空欄でも可）
   - **プライバシーポリシーURL**: 任意（開発中は空欄でも可）
4. 「作成」をクリック

### 1-4. チャネルIDとチャネルシークレットを確認
1. 作成したチャネルの設定画面を開く
2. 「チャネル基本設定」タブで以下を確認：
   - **Channel ID**: 後で使用します（例: `1234567890`）
   - **Channel Secret**: 後で使用します（「表示」をクリックして確認）

**✅ 確認ポイント**: Channel IDとChannel Secretをメモ帳にコピーしてください

---

## ステップ2: LINE LoginのコールバックURLを設定

### 2-1. LINEログイン設定タブを開く
1. 同じLINEログインチャネルの設定画面で「LINEログイン設定」タブを選択

### 2-2. コールバックURLを追加
1. 「コールバックURL」セクションで「追加」をクリック
2. 以下のURLを入力：
   ```
   http://localhost:3001/auth/callback
   ```
3. 「追加」をクリック

**✅ 確認ポイント**: コールバックURLが正しく追加されているか確認

---

## ステップ3: 環境変数を設定

### 3-1. `.env.local`ファイルを開く
1. `store/.env.local` ファイルを開く（存在しない場合は作成）

### 3-2. 環境変数を追加
以下の内容を追加または更新してください：

```env
# Supabase設定（既存）
NEXT_PUBLIC_SUPABASE_URL=https://wosgrdgnkdaxmykclazc.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indvc2dyZGdua2RheG15a2NsYXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjU4OTksImV4cCI6MjA3ODkwMTg5OX0.tAB-e53Xf8Lif8yzpJCoXsmnKM_oTAiVEMbETo4ivSg

# LINE Login設定（ステップ1-4で取得した情報を設定）
NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID=ここにChannel_IDを貼り付け
LINE_LOGIN_CHANNEL_SECRET=ここにChannel_Secretを貼り付け
NEXT_PUBLIC_LINE_LOGIN_REDIRECT_URI=http://localhost:3001/auth/callback
NEXT_PUBLIC_APP_URL=http://localhost:3001
```

**⚠️ 注意**: 
- `NEXT_PUBLIC_LIFF_ID` は**不要**になりました（削除してOK）
- `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID` にステップ1-4で取得したChannel IDを設定
- `LINE_LOGIN_CHANNEL_SECRET` にステップ1-4で取得したChannel Secretを設定

**✅ 確認ポイント**: 
- `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID` にChannel IDを設定
- `LINE_LOGIN_CHANNEL_SECRET` にChannel Secretを設定

---

## ステップ4: 開発サーバーを起動

### 4-1. ターミナルでstoreディレクトリに移動
```bash
cd store
```

### 4-2. 開発サーバーを起動
```bash
npm run dev
```

### 4-3. サーバーが起動したことを確認
- ターミナルに `http://localhost:3001` が表示されることを確認
- ブラウザで `http://localhost:3001` を開いてエラーが出ないことを確認

**✅ 確認ポイント**: サーバーが正常に起動していること

---

## ステップ5: Web環境での動作確認

### 5-1. ブラウザでアプリを開く
1. 通常のWebブラウザ（Chrome推奨）で `http://localhost:3001` を開く
2. 開発者ツール（DevTools）を開く：
   - Windows/Linux: `F12` または `Ctrl+Shift+I`
   - Mac: `Cmd+Option+I`
3. 「Console」タブを選択

### 5-2. LINEログインボタンをクリック
1. 画面に「LINEでログイン」ボタンが表示されていることを確認
2. ボタンをクリック

### 5-3. LINEログイン画面で認証
1. LINEログイン画面が表示される
2. LINEアカウントでログイン
3. 権限を許可

### 5-4. コールバック後の確認
1. `http://localhost:3001/auth/callback` にリダイレクトされる
2. コンソールに以下のログが表示されることを確認：
   ```
   [LINE Login] User ID: U1234567890abcdef...
   [LINE Login] Display Name: あなたの名前
   ```
3. **ユーザーIDをメモ帳にコピー**（例: `U1234567890abcdef...`）

**✅ 確認ポイント**: 
- ユーザーIDが取得できていること
- エラーが出ていないこと

---

## ステップ6: LIFF環境での動作確認

### 6-1. LIFF URLを取得（オプション）
**注意**: LIFF環境でもLINE Login（OAuth）を使用するため、LIFFアプリの作成は**必須ではありません**。
ただし、LINEアプリ内で開くためのLIFF URLが必要な場合は作成してください。

1. LINE Developers Consoleで、作成したLINEログインチャネルの設定画面を開く
2. 「LIFF」タブを選択
3. 「LIFFアプリを追加」をクリック
4. 以下の情報を入力：
   - **アプリ名**: 任意の名前
   - **エンドポイントURL**: `http://localhost:3001`（開発環境）
   - **サイズ**: Full（推奨）
   - **スコープ**: `profile openid email`
5. LIFF URLを取得（例: `https://liff.line.me/1234567890-abcdefgh`）

### 6-2. LINEアプリでLIFF URLを開く
1. LINEアプリを開く
2. 任意のチャット（自分とのトークでも可）で、LIFF URLを送信
3. LIFF URLをタップして開く

**⚠️ 注意**: LINEアプリ内で開く必要があります。ブラウザでは開けません。

### 6-3. LINEログインを実行
1. 画面に「LINEでログイン」ボタンが表示される
2. ボタンをクリック
3. LINEログイン画面で認証（Web環境と同じフロー）

### 6-4. ユーザーIDを確認
1. ログイン後、アプリが正常に動作することを確認
2. **ユーザーIDをメモ帳にコピー**（Web環境と同じ方法で確認）

**✅ 確認ポイント**: 
- LIFF環境でアプリが正常に動作すること
- ユーザーIDが取得できていること

---

## ステップ7: ユーザーIDの一致確認（最重要）

### 7-1. 取得したユーザーIDを比較
1. ステップ5-4で取得したWeb環境のユーザーID
2. ステップ6-4で取得したLIFF環境のユーザーID

### 7-2. 結果の確認

**✅ 同じユーザーIDの場合**:
- 🎉 **成功！** 同じLINE Login（OAuth）を使用することで、確実に同じユーザーIDが取得できています
- LIFFとWebで同じアカウントとして扱われます

**❌ 異なるユーザーIDの場合**:
- ⚠️ これは通常発生しません（同じLINE Loginを使用しているため）
- もし異なる場合は、環境変数の設定を確認してください

---

## メリット

この実装により、以下のメリットがあります：

1. **確実に同じユーザーID**: LIFF環境でもWeb環境でも、同じLINE Login（OAuth）を使用するため、確実に同じユーザーIDが取得できます
2. **シンプルな実装**: LIFFの初期化処理が不要になり、コードがシンプルになりました
3. **統一された認証フロー**: 環境に関係なく、同じ認証フローを使用します

---

## トラブルシューティング

### エラー: `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID is not set`
- `.env.local` に `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID` が設定されているか確認
- サーバーを再起動してください

### エラー: `Failed to exchange code for token`
- `LINE_LOGIN_CHANNEL_SECRET` が正しく設定されているか確認
- コールバックURLがLINE Developersで正しく設定されているか確認

### LINEログイン画面が表示されない
- `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID` が正しく設定されているか確認
- ブラウザのコンソールでエラーを確認

---

## 次のステップ

動作確認が完了したら：
1. ユーザーIDが一致することを確認（通常は確実に一致します）
2. 本番環境の設定（コールバックURL、エンドポイントURLの更新）
3. セキュリティ対策の追加（IDトークンの署名検証など）



