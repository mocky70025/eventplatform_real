# ログイン動作確認手順

## 概要

storeアプリとorganizerアプリの両方について、LINE Loginとメールアドレス認証のログイン動作確認を行います。

---

## 準備

### 1. テスト用アカウントの準備

#### LINE Login用
- LINE Developers Consoleでテストユーザーとして追加済みのLINEアカウント
- または、開発ステータスのチャネルを使用する場合は、開発者ロールを持つLINEアカウント
- **既に登録済みのLINEアカウント**（新規登録を完了していること）

#### メールアドレス・パスワード用（Web環境のみ）
- **既に登録済みのメールアドレス・パスワード**
  - 出店者用：`test-exhibitor-existing@example.com`
  - 主催者用：`test-organizer-existing@example.com`

### 2. ブラウザの準備
- 開発者ツールを開ける状態（F12）
- コンソールタブを確認できる状態

### 3. アプリケーションURL
- 出店者アプリ（Web）：`https://tomorrow-event-platform-store.vercel.app`
- 主催者アプリ（Web）：`https://tomorrow-event-platform-organizer.vercel.app`
- 出店者アプリ（LIFF）：LINE Developers Consoleで取得したLIFF URL
- 主催者アプリ（LIFF）：LINE Developers Consoleで取得したLIFF URL

---

## 出店者アプリ（store）のログイン確認

### Web環境での確認

#### パターン1: LINE Login（既存ユーザー）

**事前準備：**
- データベースに該当するLINEアカウントの出店者データが存在することを確認
- Supabase Dashboard > Authentication > Users で確認

**手順：**
1. **アプリにアクセス**
   - `https://tomorrow-event-platform-store.vercel.app` を開く
   - ブラウザの開発者ツールを開く（F12）
   - 「Console」タブを選択

2. **初期画面の確認**
   - ✅ 「ログイン」と「新規登録」のボタンが表示される
   - ✅ 「ログイン」をクリック

3. **認証方法選択**
   - ✅ 「ログイン方法を選択」というタイトルが表示される
   - ✅ 「LINEでログイン」と「メールアドレスでログイン」のボタンが表示される
   - ✅ 「LINEでログイン」をクリック

4. **LINE Login認証**
   - ✅ コンソールに `[WelcomeScreen] LINE Login button clicked, authMode: login` と表示される
   - ✅ コンソールに `[WelcomeScreen] LINE Login URL generated, redirecting to: ...` と表示される
   - ✅ LINE Loginの認証画面にリダイレクトされる
   - ✅ LINEアカウントでログイン

5. **コールバック処理**
   - ✅ アプリに戻る（`/auth/callback`）
   - ✅ コンソールに以下のログが表示される：
     ```
     [LINE Login] User ID: ...
     [LINE Login] Display Name: ...
     [Callback] Profile saved to sessionStorage: ...
     [Callback] Is registered: true
     [Callback] Redirecting to home page immediately...
     ```

6. **ホーム画面表示**
   - ✅ 登録フォームではなく、ホーム画面（イベント一覧）が表示される
   - ✅ コンソールに `[Home] LINE Login user profile set: ...` と表示される
   - ✅ 下部にナビゲーションバー（イベント、登録情報、申し込み）が表示される

**確認ポイント：**
- [ ] ログイン方法選択画面が表示される
- [ ] LINE Loginの認証フローが正常に動作する
- [ ] コールバック後、ホーム画面が表示される
- [ ] 登録フォームが表示されない（既存ユーザーのため）
- [ ] コンソールにエラーが表示されない

---

#### パターン2: メールアドレス・パスワード（既存ユーザー）

**事前準備：**
- データベースに該当するメールアドレスの出店者データが存在することを確認
- Supabase Authに該当するメールアドレスのユーザーが存在することを確認

**手順：**
1. **アプリにアクセス**
   - `https://tomorrow-event-platform-store.vercel.app` を開く
   - ブラウザの開発者ツールを開く（F12）
   - 「Console」タブを選択

2. **初期画面の確認**
   - ✅ 「ログイン」をクリック

3. **認証方法選択**
   - ✅ 「メールアドレスでログイン」をクリック

4. **ログインフォーム入力**
   - ✅ メールアドレスとパスワードを入力
   - ✅ 「ログイン」をクリック

5. **ログイン処理**
   - ✅ コンソールに `[WelcomeScreen] Email login - email: ...` と表示される
   - ✅ ログイン処理が実行される

6. **ホーム画面表示**
   - ✅ 登録フォームではなく、ホーム画面（イベント一覧）が表示される
   - ✅ コンソールに `[Home] Email auth session found: ...` と表示される
   - ✅ メール確認バナーが表示されない（確認済みの場合）

**確認ポイント：**
- [ ] メールアドレス・パスワードでログインできる
- [ ] ホーム画面（イベント一覧）が表示される
- [ ] 登録フォームが表示されない（既存ユーザーのため）
- [ ] コンソールにエラーが表示されない

---

### LIFF環境での確認

#### パターン3: LINE Login（既存ユーザー）- LIFF環境

**事前準備：**
- LINE Developers ConsoleでLIFFアプリを作成
- LIFF URLを取得
- データベースに該当するLINEアカウントの出店者データが存在することを確認

**手順：**
1. **LIFF URLを開く**
   - LINEアプリでLIFF URLを開く
   - または、任意のチャットでLIFF URLを送信してタップ

2. **初期画面の確認**
   - ✅ 「ログイン」と「新規登録」のボタンが表示される
   - ✅ コンソールに `[Home] Environment: LIFF` と表示される（開発者ツールで確認可能な場合）
   - ✅ 「ログイン」をクリック

3. **認証方法選択**
   - ✅ 「ログイン方法を選択」というタイトルが表示される
   - ✅ **「LINEでログイン」ボタンのみが表示される**（メールアドレスでログインは表示されない）
   - ✅ 「LINEでログイン」をクリック

4. **LINE Login認証**
   - ✅ LINE Loginの認証画面にリダイレクトされる（外部ブラウザで開く場合がある）
   - ✅ LINEアカウントでログイン

5. **コールバック処理**
   - ✅ アプリに戻る（`/auth/callback`）
   - ✅ コールバック処理が実行される

6. **ホーム画面表示**
   - ✅ 登録フォームではなく、ホーム画面（イベント一覧）が表示される

**確認ポイント：**
- [ ] LIFF環境では、メールアドレス認証のボタンが表示されない
- [ ] LINE認証のみが利用できる
- [ ] LINE Loginの認証フローが正常に動作する
- [ ] コールバック後、ホーム画面が表示される
- [ ] 登録フォームが表示されない（既存ユーザーのため）

---

## 主催者アプリ（organizer）のログイン確認

### Web環境での確認

#### パターン4: LINE Login（既存ユーザー）

**事前準備：**
- データベースに該当するLINEアカウントの主催者データが存在することを確認

**手順：**
1. **アプリにアクセス**
   - `https://tomorrow-event-platform-organizer.vercel.app` を開く
   - ブラウザの開発者ツールを開く（F12）
   - 「Console」タブを選択

2. **初期画面の確認**
   - ✅ 「ログイン」をクリック

3. **認証方法選択**
   - ✅ 「LINEでログイン」と「メールアドレスでログイン」のボタンが表示される
   - ✅ 「LINEでログイン」をクリック

4. **LINE Login認証**
   - ✅ LINE Loginの認証画面にリダイレクトされる
   - ✅ LINEアカウントでログイン

5. **コールバック処理**
   - ✅ アプリに戻る（`/auth/callback`）
   - ✅ コンソールにログが表示される

6. **ホーム画面表示**
   - ✅ 登録フォームではなく、ホーム画面（イベント管理）が表示される

**確認ポイント：**
- [ ] LINE Loginの認証フローが正常に動作する
- [ ] コールバック後、ホーム画面が表示される
- [ ] 登録フォームが表示されない（既存ユーザーのため）

---

#### パターン5: メールアドレス・パスワード（既存ユーザー）

**事前準備：**
- データベースに該当するメールアドレスの主催者データが存在することを確認
- Supabase Authに該当するメールアドレスのユーザーが存在することを確認

**手順：**
1. **アプリにアクセス**
   - `https://tomorrow-event-platform-organizer.vercel.app` を開く
   - ブラウザの開発者ツールを開く（F12）
   - 「Console」タブを選択

2. **初期画面の確認**
   - ✅ 「ログイン」をクリック

3. **認証方法選択**
   - ✅ 「メールアドレスでログイン」をクリック

4. **ログインフォーム入力**
   - ✅ メールアドレスとパスワードを入力
   - ✅ 「ログイン」をクリック

5. **ログイン処理**
   - ✅ ログイン処理が実行される

6. **ホーム画面表示**
   - ✅ 登録フォームではなく、ホーム画面（イベント管理）が表示される
   - ✅ メール確認バナーが表示されない（確認済みの場合）

**確認ポイント：**
- [ ] メールアドレス・パスワードでログインできる
- [ ] ホーム画面（イベント管理）が表示される
- [ ] 登録フォームが表示されない（既存ユーザーのため）

---

### LIFF環境での確認

#### パターン6: LINE Login（既存ユーザー）- LIFF環境

**事前準備：**
- LINE Developers Consoleで主催者用のLIFFアプリを作成
- LIFF URLを取得
- データベースに該当するLINEアカウントの主催者データが存在することを確認

**手順：**
1. **LIFF URLを開く**
   - LINEアプリでLIFF URLを開く

2. **初期画面の確認**
   - ✅ 「ログイン」をクリック

3. **認証方法選択**
   - ✅ **「LINEでログイン」ボタンのみが表示される**（メールアドレスでログインは表示されない）
   - ✅ 「LINEでログイン」をクリック

4. **LINE Login認証**
   - ✅ LINE Loginの認証画面にリダイレクトされる（外部ブラウザで開く場合がある）
   - ✅ LINEアカウントでログイン

5. **コールバック処理**
   - ✅ アプリに戻る（`/auth/callback`）
   - ✅ コールバック処理が実行される

6. **ホーム画面表示**
   - ✅ 登録フォームではなく、ホーム画面（イベント管理）が表示される

**確認ポイント：**
- [ ] LIFF環境では、メールアドレス認証のボタンが表示されない
- [ ] LINE認証のみが利用できる
- [ ] LINE Loginの認証フローが正常に動作する
- [ ] コールバック後、ホーム画面が表示される
- [ ] 登録フォームが表示されない（既存ユーザーのため）

---

## エラーケースの確認

### 1. 存在しないLINEアカウントでログイン

**手順：**
1. 登録していないLINEアカウントでログインを試す
2. ✅ コールバック後、登録フォームが表示される（新規ユーザーとして扱われる）

**確認ポイント：**
- [ ] エラーメッセージが表示されない
- [ ] 登録フォームが表示される

---

### 2. 存在しないメールアドレスでログイン

**手順：**
1. 登録していないメールアドレスでログインを試す
2. ✅ エラーメッセージが表示される
   - 例: 「Invalid login credentials」

**確認ポイント：**
- [ ] 適切なエラーメッセージが表示される
- [ ] ログインできない

---

### 3. 間違ったパスワードでログイン

**手順：**
1. 正しいメールアドレスと間違ったパスワードでログインを試す
2. ✅ エラーメッセージが表示される
   - 例: 「Invalid login credentials」

**確認ポイント：**
- [ ] 適切なエラーメッセージが表示される
- [ ] ログインできない

---

## 動作確認チェックリスト

### 出店者アプリ（store）

#### Web環境
- [ ] パターン1: LINE Login（既存ユーザー）
- [ ] パターン2: メールアドレス・パスワード（既存ユーザー）

#### LIFF環境
- [ ] パターン3: LINE Login（既存ユーザー）- LIFF環境
- [ ] **重要**: LIFF環境では、メールアドレス認証のボタンが表示されないことを確認

### 主催者アプリ（organizer）

#### Web環境
- [ ] パターン4: LINE Login（既存ユーザー）
- [ ] パターン5: メールアドレス・パスワード（既存ユーザー）

#### LIFF環境
- [ ] パターン6: LINE Login（既存ユーザー）- LIFF環境
- [ ] **重要**: LIFF環境では、メールアドレス認証のボタンが表示されないことを確認

### エラーケース
- [ ] 存在しないLINEアカウントでログイン
- [ ] 存在しないメールアドレスでログイン
- [ ] 間違ったパスワードでログイン

---

## 確認のポイント

### 正常なログイン
1. ✅ ログイン方法選択画面が表示される
2. ✅ 認証フローが正常に動作する
3. ✅ コールバック後、ホーム画面が表示される
4. ✅ 登録フォームが表示されない（既存ユーザーのため）
5. ✅ コンソールにエラーが表示されない

### LIFF環境での確認
- ✅ メールアドレス認証のボタンが表示されない
- ✅ LINE認証のみが利用できる

### エラーケース
- ✅ 適切なエラーメッセージが表示される
- ✅ ログインできない

---

## トラブルシューティング

### ログイン後、最初のページに戻る場合

1. **ブラウザのコンソールを確認**
   - エラーメッセージがないか確認
   - `[Callback]` で始まるログを確認
   - `[Home]` で始まるログを確認

2. **セッションストレージを確認**
   - 開発者ツール > 「Application」タブ > 「Session Storage」を開く
   - `line_profile` が保存されているか確認
   - `is_registered` が `true` になっているか確認

3. **Supabase Dashboardで確認**
   - Authentication > Users でユーザーが存在するか確認
   - データベースで出店者/主催者データが存在するか確認

### メールアドレス認証のボタンが表示される場合（LIFF環境）

1. **ブラウザのコンソールで確認**
   - `[Home] Environment: LIFF` が表示されるか確認
   - `isLiffEnvironment()` 関数が正しく動作しているか確認

2. **URLを確認**
   - LIFF URLが正しく設定されているか確認
   - `liff.line.me` がURLに含まれているか確認

---

## 完了条件

全てのパターンについて以下が確認できれば完了です：

1. ✅ ログイン方法選択画面が表示される
2. ✅ 認証フローが正常に動作する
3. ✅ コールバック後、ホーム画面が表示される
4. ✅ 登録フォームが表示されない（既存ユーザーのため）
5. ✅ LIFF環境では、メールアドレス認証のボタンが表示されない
6. ✅ エラーケースで適切なエラーメッセージが表示される

