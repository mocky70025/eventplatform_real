# メール送信問題解決手順（メール確認有効のまま）

## 重要：メール確認は有効のまま解決します

メール確認機能をテストするため、メール確認は無効にしません。

## 確認手順

### ステップ1: Supabase Dashboardで設定を確認

#### 1-1. メール確認設定の確認

1. **Supabase Dashboardにログイン**
   - https://supabase.com/dashboard にアクセス
   - プロジェクトを選択

2. **「Authentication」> 「Settings」を開く**

3. **「Email Auth」セクションを確認**
   - ✅ 「Enable email confirmations」が **ON** になっているか確認
   - ✅ 「Enable email signup」が **ON** になっているか確認

4. **「URL Configuration」セクションを確認**
   - ✅ 「Site URL」が正しく設定されているか確認
     - 例: `https://tomorrow-event-platform-organizer.vercel.app`
   - ✅ 「Redirect URLs」に以下が追加されているか確認：
     ```
     https://tomorrow-event-platform-organizer.vercel.app/auth/verify-email
     https://tomorrow-event-platform-organizer.vercel.app/**
     ```
   - ⚠️ **重要**: リダイレクトURLが設定されていないと、メールが送信されない場合があります

#### 1-2. ユーザーの確認

1. **「Authentication」> 「Users」を開く**
2. **登録したメールアドレスでユーザーが作成されているか確認**
3. **ユーザーが存在する場合：**
   - 「Email confirmed」が `false` になっているか確認
   - 「Created at」の時刻を確認（登録時刻と一致するか）
   - 「Last sign in」が `null` になっているか確認

### ステップ2: ブラウザのコンソールでログを確認

1. **開発者ツールを開く**（F12）
2. **「Console」タブを開く**
3. **メールアドレス新規登録を実行**
4. **以下のログを確認**：

```
[WelcomeScreen] Email registration - redirectUrl: ...
[WelcomeScreen] Email registration - window.location.origin: ...
[WelcomeScreen] Email registration - NEXT_PUBLIC_APP_URL: ...
[WelcomeScreen] Email registration - email: ...
[WelcomeScreen] SignUp response: ...
[WelcomeScreen] User created successfully: ...
```

5. **特に重要なログ**：
   - `⚠️ Email confirmation required but no session - email should be sent`
     - このログが表示される場合、メールが送信されるはずです
   - `⚠️ Session exists - email confirmation may be disabled`
     - このログが表示される場合、メール確認が無効になっている可能性があります

### ステップ3: Supabaseのメール送信ログを確認

1. **Supabase Dashboard > 「Logs」> 「Auth Logs」を開く**
2. **最近のログを確認**
   - メール送信の試行が記録されているか
   - エラーが記録されていないか
   - 特に以下のエラーがないか確認：
     - `Email rate limit exceeded`
     - `Invalid redirect URL`
     - `Email sending failed`

### ステップ4: メール送信のテスト（Supabase Dashboardから）

**Supabase Dashboardから直接メールを送信してテスト：**

1. **「Authentication」> 「Users」を開く**
2. **登録したユーザーを選択**
3. **「Send magic link」または「Resend confirmation email」をクリック**
4. **メールが届くか確認**
   - この方法でメールが届く場合：設定は正しいが、アプリからの送信に問題がある可能性
   - この方法でメールが届かない場合：Supabaseのメール送信機能自体に問題がある可能性

### ステップ5: 環境変数の確認

1. **Vercelの環境変数を確認**
   - `NEXT_PUBLIC_APP_URL` が正しく設定されているか確認
   - 例: `https://tomorrow-event-platform-organizer.vercel.app`

2. **ブラウザのコンソールで確認**
   - `[WelcomeScreen] Email registration - NEXT_PUBLIC_APP_URL:` のログを確認
   - 値が正しく設定されているか確認

## よくある問題と解決方法

### 問題1: リダイレクトURLが設定されていない

**症状：**
- ユーザーは作成されるが、メールが送信されない
- メール送信のログに `Invalid redirect URL` エラーが記録されている

**解決方法：**
1. Supabase Dashboard > 「Authentication」> 「URL Configuration」を開く
2. 「Redirect URLs」に以下を追加：
   ```
   https://tomorrow-event-platform-organizer.vercel.app/auth/verify-email
   https://tomorrow-event-platform-organizer.vercel.app/**
   ```
3. 「Save」をクリック
4. **重要**: 変更後、数分待ってから再度試す（設定の反映に時間がかかる場合があります）

### 問題2: LIFF環境でのリダイレクトURLの問題

**症状：**
- LIFF環境で登録した場合、リダイレクトURLがLIFF URLになっている

**確認方法：**
1. ブラウザのコンソールで `[WelcomeScreen] Email registration - redirectUrl:` のログを確認
2. リダイレクトURLが正しいか確認（例: `https://tomorrow-event-platform-organizer.vercel.app/auth/verify-email`）

**解決方法：**
- `NEXT_PUBLIC_APP_URL` 環境変数が正しく設定されているか確認
- Vercelの環境変数設定を確認

### 問題3: メール送信の制限に達している

**症状：**
- メール送信のログに `Email rate limit exceeded` エラーが記録されている

**解決方法：**
1. Supabase Dashboard > 「Settings」> 「Usage」を開く
2. メール送信の使用状況を確認
3. 制限に達している場合は、時間をおいてから再度試す
4. または、カスタムSMTPサーバーを設定する（有料プラン）

### 問題4: メール送信の遅延

**症状：**
- ユーザーは作成されるが、メールがすぐに届かない

**解決方法：**
- 数分待ってから再度確認（Supabaseの無料プランでは、メール送信に数分かかる場合があります）
- メール確認待ち画面で「確認メールを再送信」ボタンをクリック

### 問題5: スパムフォルダに入っている

**症状：**
- メールが届かないが、Supabase Dashboardでは送信されている

**解決方法：**
1. スパムフォルダ（迷惑メールフォルダ）を確認
2. メールプロバイダーによっては、Supabaseからのメールがスパムとして分類される場合があります

## デバッグ情報の収集

問題が解決しない場合、以下の情報を収集してください：

1. **ブラウザのコンソールログ**（全て）
   - 特に `[WelcomeScreen]` で始まるログ
2. **Supabase Dashboardのスクリーンショット**：
   - Authentication > Settings（Email Auth セクション）
   - Authentication > Settings（URL Configuration セクション）
   - Authentication > Users（登録したユーザー）
   - Logs > Auth Logs（最近のログ）
3. **登録時に使用したメールアドレス**
4. **登録時刻**
5. **環境変数の値**（`NEXT_PUBLIC_APP_URL`）

## 次のステップ

1. **ステップ1から順番に確認**
2. **特に「リダイレクトURL」の設定を確認**（これが最も可能性が高い原因です）
3. **Supabase Dashboardから直接メールを送信してテスト**
4. **それでも解決しない場合は、上記のデバッグ情報を収集して、さらに調査**

## 重要な確認ポイント

✅ **「Enable email confirmations」が ON になっているか**
✅ **「Redirect URLs」に正しいURLが追加されているか**
✅ **`NEXT_PUBLIC_APP_URL` 環境変数が正しく設定されているか**
✅ **ブラウザのコンソールにエラーが表示されていないか**
✅ **Supabase Dashboardのログにエラーが記録されていないか**

