# LIFF版主催者アプリ動作確認手順

## 概要

LIFF版の主催者アプリで、メールアドレス認証とLINE認証の動作確認を行います。

## 前提条件

1. **LIFFアプリの作成**
   - LINE Developers Consoleで主催者用のLIFFアプリを作成
   - エンドポイントURLを設定（例: `https://tomorrow-event-platform-organizer.vercel.app`）

2. **環境変数の設定**
   - Vercelまたはローカル環境で、主催者アプリの環境変数が設定されていること
   - `NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID`: 主催者用のLINE LoginチャネルID
   - `LINE_LOGIN_CHANNEL_SECRET`: 主催者用のLINE Loginチャネルシークレット
   - `NEXT_PUBLIC_LINE_LOGIN_REDIRECT_URI`: 主催者アプリのコールバックURL

3. **LIFF URLの取得**
   - LINE Developers Consoleで、作成したLIFFアプリのLIFF URLを取得
   - 例: `https://liff.line.me/1234567890-abcdefgh`

## 動作確認手順

### パターン1: LINE認証（新規登録）

#### 手順
1. **LIFF URLを開く**
   - LINEアプリで、主催者用のLIFF URLを開く
   - または、任意のチャットでLIFF URLを送信してタップ

2. **初期画面の確認**
   - ✅ 「新規登録」と「ログイン」のボタンが表示される
   - ✅ コンソールに `[Home] Environment: LIFF` と表示される
   - ✅ 「新規登録」をクリック

3. **認証方法選択**
   - ✅ 「LINEで新規登録」と「メールアドレスで新規登録」のボタンが表示される
   - ✅ 「LINEで新規登録」をクリック

4. **LINE Login**
   - ✅ LINE Loginの認証画面にリダイレクトされる（外部ブラウザで開く場合がある）
   - ✅ LINEアカウントでログイン
   - ✅ アプリに戻る（コールバック）

5. **登録フォーム表示**
   - ✅ 登録フォームが表示される
   - ✅ フォームに入力できる

6. **登録完了**
   - ✅ フォームを送信
   - ✅ 「登録が完了しました」画面が表示される
   - ✅ ホーム画面に戻る

#### 確認ポイント
- [ ] LIFF環境が正しく検出される
- [ ] LINE Loginの認証フローが正常に動作する
- [ ] コールバック後、登録フォームが表示される
- [ ] 登録フォームに入力・送信できる
- [ ] 登録完了後、ホーム画面に戻る

---

### パターン2: LINE認証（既存ユーザー）

#### 手順
1. **事前準備**
   - パターン1で登録済みのLINEアカウントを使用
   - または、既に登録済みのLINEアカウントを用意

2. **LIFF URLを開く**
   - LINEアプリで、主催者用のLIFF URLを開く

3. **ログイン**
   - ✅ 「ログイン」をクリック
   - ✅ 「LINEでログイン」をクリック
   - ✅ LINE Loginの認証画面でログイン

4. **ホーム画面表示**
   - ✅ 登録フォームではなく、ホーム画面（イベント管理）が表示される
   - ✅ 登録情報が表示される（プロフィール画面）

#### 確認ポイント
- [ ] 既存ユーザーは登録フォームが表示されない
- [ ] ホーム画面（イベント管理）が表示される
- [ ] 登録情報が正しく表示される

---

### パターン3: メールアドレス・パスワード（新規登録）

#### 手順
1. **LIFF URLを開く**
   - LINEアプリで、主催者用のLIFF URLを開く

2. **初期画面の確認**
   - ✅ 「新規登録」をクリック

3. **認証方法選択**
   - ✅ 「メールアドレスで新規登録」をクリック

4. **登録フォーム入力**
   - ✅ メールアドレスを入力（例: `test-organizer-liff-new@example.com`）
   - ✅ パスワードを入力（6文字以上）
   - ✅ パスワード（確認）を入力
   - ✅ 「登録する」をクリック

5. **確認メール送信**
   - ✅ 「確認メールを送信しました」というメッセージが表示される
   - ✅ メール確認待ち画面が表示される

6. **メール確認（注意）**
   - ⚠️ LIFF環境では、メール確認リンクをクリックすると外部ブラウザで開く必要がある場合があります
   - ✅ メールアドレスに確認メールが届く
   - ✅ メール内のリンクをクリック（外部ブラウザで開く）
   - ✅ メール確認ページにリダイレクトされる
   - ✅ 「メールアドレスの確認が完了しました」と表示される
   - ⚠️ 外部ブラウザで確認した後、LIFFアプリに戻る必要がある場合があります

7. **登録フォーム表示**
   - ✅ LIFFアプリに戻る
   - ✅ メール確認が完了している場合は、登録フォームが表示される
   - ✅ フォームに入力できる

8. **登録完了**
   - ✅ フォームを送信
   - ✅ 「登録が完了しました」画面が表示される

#### 確認ポイント
- [ ] メールアドレス・パスワードで新規登録できる
- [ ] 確認メールが送信される
- [ ] メール確認待ち画面が表示される
- [ ] メール確認リンクが正常に動作する（外部ブラウザで開く）
- [ ] メール確認後、LIFFアプリに戻って登録フォームが表示される
- [ ] 登録フォームに入力・送信できる

---

### パターン4: メールアドレス・パスワード（既存ユーザー）

#### 手順
1. **事前準備**
   - パターン3で登録済みのメールアドレス・パスワードを使用
   - または、既に登録済みのアカウントを用意

2. **LIFF URLを開く**
   - LINEアプリで、主催者用のLIFF URLを開く

3. **ログイン**
   - ✅ 「ログイン」をクリック
   - ✅ 「メールアドレスでログイン」をクリック
   - ✅ メールアドレスとパスワードを入力
   - ✅ 「ログイン」をクリック

4. **ホーム画面表示**
   - ✅ 登録フォームではなく、ホーム画面（イベント管理）が表示される
   - ✅ メール確認バナーが表示されない（確認済みの場合）

#### 確認ポイント
- [ ] 既存ユーザーは登録フォームが表示されない
- [ ] ホーム画面（イベント管理）が表示される
- [ ] メール確認バナーが表示されない（確認済みの場合）

---

## LIFF環境特有の注意点

### 1. 外部ブラウザへのリダイレクト

LIFF環境では、以下の場合に外部ブラウザへのリダイレクトが必要です：

- **LINE Login（OAuth）**: 認証画面は外部ブラウザで開く必要がある場合があります
- **メール確認リンク**: メール内のリンクをクリックすると、外部ブラウザで開く必要があります

### 2. セッションの保持

- LIFF環境と外部ブラウザ間でセッションが共有されない場合があります
- メール確認後、LIFFアプリに戻る際に、再度ログインが必要な場合があります

### 3. 動作確認の推奨方法

1. **LIFF環境での確認**
   - LINEアプリ内でLIFF URLを開く
   - 認証フローを確認

2. **外部ブラウザでの確認**
   - 同じURLを外部ブラウザで開く
   - 認証フローを確認
   - LIFF環境とWeb環境で同じ動作をすることを確認

## トラブルシューティング

### LIFF環境が検出されない場合

1. **コンソールを確認**
   - `[Home] Environment: LIFF` が表示されるか確認
   - 表示されない場合は、`isLiffEnvironment()` 関数を確認

2. **URLを確認**
   - LIFF URLが正しく設定されているか確認
   - `liff.line.me` がURLに含まれているか確認

### LINE Loginが動作しない場合

1. **外部ブラウザでのリダイレクト**
   - LIFF環境では、`liff.openWindow()` を使用して外部ブラウザで開く必要がある場合があります
   - 現在の実装では、`window.location.href` を使用していますが、LIFF SDKが利用可能な場合は `liff.openWindow()` を使用します

2. **コールバックURLの確認**
   - LINE Developers Consoleで、コールバックURLが正しく設定されているか確認
   - LIFF環境でも、同じコールバックURLを使用します

### メール確認が動作しない場合

1. **外部ブラウザでの確認**
   - メール確認リンクは、外部ブラウザで開く必要があります
   - LIFF環境内では開けない場合があります

2. **セッションの確認**
   - メール確認後、LIFFアプリに戻る際に、セッションが保持されているか確認
   - 保持されていない場合は、再度ログインが必要です

## 動作確認チェックリスト

### LINE認証
- [ ] パターン1: LINE認証（新規登録）
- [ ] パターン2: LINE認証（既存ユーザー）

### メールアドレス認証
- [ ] パターン3: メールアドレス・パスワード（新規登録）
- [ ] パターン4: メールアドレス・パスワード（既存ユーザー）

### LIFF環境特有
- [ ] LIFF環境が正しく検出される
- [ ] 外部ブラウザへのリダイレクトが正常に動作する
- [ ] メール確認後、LIFFアプリに戻って正常に動作する

