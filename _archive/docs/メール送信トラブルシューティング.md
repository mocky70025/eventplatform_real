# メール送信トラブルシューティング

## 問題: メールアドレス新規登録で確認メールが届かない

### 確認手順

#### 1. ブラウザのコンソールを確認

1. 開発者ツールを開く（F12 または 右クリック > 検証）
2. 「Console」タブを開く
3. メールアドレス新規登録を実行
4. 以下のログを確認：
   - `[WelcomeScreen] Email registration - redirectUrl: ...`
   - `[WelcomeScreen] SignUp response: ...`
   - `[WelcomeScreen] User created successfully: ...`
   - エラーメッセージがないか確認

#### 2. Supabase Dashboardでユーザーを確認

1. Supabase Dashboardにログイン
2. 「Authentication」> 「Users」を開く
3. 登録したメールアドレスでユーザーが作成されているか確認
4. ユーザーが存在する場合：
   - 「Email confirmed」が `false` になっているか確認
   - 「Created at」の時刻を確認（登録時刻と一致するか）

#### 3. Supabase Authのメール送信設定を確認

1. Supabase Dashboard > 「Authentication」> 「Settings」を開く
2. 「Email Auth」セクションを確認：
   - ✅ 「Enable email confirmations」が **ON** になっているか
   - ✅ 「Email template」が正しく設定されているか

3. 「URL Configuration」セクションを確認：
   - ✅ 「Site URL」が正しく設定されているか
     - 例: `https://tomorrow-event-platform-organizer.vercel.app`
   - ✅ 「Redirect URLs」に以下が追加されているか：
     - `https://tomorrow-event-platform-organizer.vercel.app/auth/verify-email`
     - `https://tomorrow-event-platform-organizer.vercel.app/**`（ワイルドカード）

#### 4. メール送信の制限を確認

**Supabaseの無料プランでは、メール送信に制限があります：**

- 1時間あたりのメール送信数に制限がある場合があります
- 開発環境では、メール送信が遅延する場合があります
- 本番環境でも、メール送信が数分かかる場合があります

**確認方法：**
1. Supabase Dashboard > 「Settings」> 「Usage」を開く
2. メール送信の使用状況を確認
3. 制限に達していないか確認

#### 5. スパムフォルダを確認

1. 登録したメールアドレスの受信トレイを確認
2. **スパムフォルダ（迷惑メールフォルダ）を確認**
3. メールプロバイダーによっては、Supabaseからのメールがスパムとして分類される場合があります

#### 6. メールアドレスの形式を確認

- 正しいメールアドレス形式か確認
- 例: `test@example.com`（有効）、`test@`（無効）

#### 7. メール送信の再試行

1. メール確認待ち画面で「確認メールを再送信」ボタンをクリック
2. 再度メールが届くか確認

### よくある原因と解決方法

#### 原因1: Supabase Authのメール確認が無効になっている

**解決方法：**
1. Supabase Dashboard > 「Authentication」> 「Settings」を開く
2. 「Enable email confirmations」を **ON** にする
3. 「Save」をクリック

#### 原因2: リダイレクトURLが設定されていない

**解決方法：**
1. Supabase Dashboard > 「Authentication」> 「URL Configuration」を開く
2. 「Redirect URLs」に以下を追加：
   ```
   https://tomorrow-event-platform-organizer.vercel.app/auth/verify-email
   https://tomorrow-event-platform-organizer.vercel.app/**
   ```
3. 「Save」をクリック

#### 原因3: LIFF環境でのリダイレクトURLの問題

LIFF環境では、`window.location.origin` がLIFF URLになる可能性があります。

**確認方法：**
1. ブラウザのコンソールで `[WelcomeScreen] Email registration - redirectUrl:` のログを確認
2. リダイレクトURLが正しいか確認（例: `https://tomorrow-event-platform-organizer.vercel.app/auth/verify-email`）

**解決方法：**
- 環境変数でリダイレクトURLを固定する
- または、LIFF環境を検出して、適切なリダイレクトURLを使用する

#### 原因4: メール送信の遅延

**解決方法：**
- 数分待ってから再度確認
- メール確認待ち画面で「確認メールを再送信」ボタンをクリック

#### 原因5: Supabaseの無料プランでの制限

**解決方法：**
- カスタムSMTPサーバーを設定する（有料プラン）
- または、開発環境ではメール確認を無効にする

### デバッグ用の追加ログ

現在の実装では、以下のログが出力されます：

```
[WelcomeScreen] Email registration - redirectUrl: ...
[WelcomeScreen] Email registration - email: ...
[WelcomeScreen] SignUp response: ...
[WelcomeScreen] User created successfully: ...
```

これらのログを確認して、問題の原因を特定してください。

### 次のステップ

1. ブラウザのコンソールでログを確認
2. Supabase Dashboardでユーザーと設定を確認
3. 上記の原因と解決方法を試す
4. それでも解決しない場合は、Supabaseのサポートに問い合わせる

