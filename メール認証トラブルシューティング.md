# メール認証トラブルシューティング

## 問題: たまにメールアドレスで新規アカウント登録しようとした時に、メールが届かない

---

## 考えられる原因と対処法

### 1. Supabaseのメール送信レート制限

**原因:**
- Supabaseの無料プランでは、1時間あたりのメール送信数に制限があります
- 短時間に複数のメール送信リクエストがあると、一部が制限に引っかかる可能性があります

**確認方法:**
1. Supabase Dashboard > Authentication > Users でユーザーが作成されているか確認
2. Supabase Dashboard > Logs でメール送信のエラーログを確認

**対処法:**
- しばらく待ってから再度試す
- Supabaseの有料プランにアップグレードする
- カスタムSMTPサーバーを設定する（後述）

---

### 2. スパムフィルターに引っかかっている

**原因:**
- メールがスパムフォルダに入っている可能性があります
- 特にGmail、Yahooメールなどで発生しやすい

**確認方法:**
- ユーザーにスパムフォルダを確認してもらう
- 迷惑メールフォルダを確認してもらう

**対処法:**
- ユーザーにスパムフォルダを確認してもらう
- メール送信元アドレスを信頼できるドメインに設定する
- SPF、DKIM、DMARCレコードを設定する

---

### 3. Supabaseのメール送信設定の問題

**原因:**
- Supabaseのメール送信サービスが正しく設定されていない
- メール確認が有効になっているが、メール送信が失敗している

**確認方法:**
1. Supabase Dashboard > Authentication > Settings > Email Templates を確認
2. Supabase Dashboard > Authentication > Settings > SMTP Settings を確認
3. Supabase Dashboard > Logs でエラーログを確認

**対処法:**
- カスタムSMTPサーバーを設定する（推奨）
- メール送信の再試行機能を実装する（後述）

---

### 4. メールアドレスの入力ミス

**原因:**
- ユーザーが間違ったメールアドレスを入力している
- メールアドレスの形式が正しくない

**確認方法:**
- ブラウザのコンソールで入力されたメールアドレスを確認
- Supabase Dashboard > Authentication > Users で登録されたメールアドレスを確認

**対処法:**
- メールアドレスのバリデーションを強化する
- ユーザーにメールアドレスの確認を促す

---

### 5. メール送信のキューイング遅延

**原因:**
- メール送信がキューに入っているが、処理が遅れている
- サーバーの負荷が高い

**確認方法:**
- Supabase Dashboard > Logs でメール送信のログを確認
- メール送信のタイムスタンプを確認

**対処法:**
- しばらく待ってから再度確認する
- メール送信の再試行機能を実装する

---

### 6. 環境変数の設定ミス

**原因:**
- `NEXT_PUBLIC_APP_URL`が正しく設定されていない
- リダイレクトURLが正しく生成されていない

**確認方法:**
1. ブラウザのコンソールで`redirectUrl`を確認
2. 環境変数が正しく設定されているか確認

**対処法:**
- 環境変数を正しく設定する
- リダイレクトURLが正しく生成されているか確認する

---

## 推奨される対処法

### 1. カスタムSMTPサーバーの設定

Supabaseのデフォルトメール送信サービスではなく、カスタムSMTPサーバー（SendGrid、Mailgun、AWS SESなど）を設定することで、メール送信の信頼性を向上させることができます。

**設定手順:**
1. Supabase Dashboard > Authentication > Settings > SMTP Settings を開く
2. カスタムSMTPサーバーの情報を入力
3. テストメールを送信して確認

---

### 2. メール送信の再試行機能の実装

メール送信が失敗した場合に、自動的に再試行する機能を実装することで、メールが届かない問題を軽減できます。

**実装例:**
```typescript
const resendConfirmationEmail = async (email: string, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const { error } = await supabase.auth.resend({
        type: 'signup',
        email: email,
        options: {
          emailRedirectTo: redirectUrl
        }
      })
      
      if (!error) {
        console.log('Confirmation email sent successfully')
        return true
      }
      
      // レート制限エラーの場合、少し待ってから再試行
      if (error.message?.includes('rate limit')) {
        await new Promise(resolve => setTimeout(resolve, 60000)) // 1分待つ
        continue
      }
      
      throw error
    } catch (err) {
      console.error(`Attempt ${i + 1} failed:`, err)
      if (i === maxRetries - 1) {
        throw err
      }
      await new Promise(resolve => setTimeout(resolve, 5000)) // 5秒待つ
    }
  }
  return false
}
```

---

### 3. メール送信状態の可視化

ユーザーにメール送信の状態を明確に伝えることで、ユーザーの混乱を減らすことができます。

**実装例:**
- メール送信成功時に「確認メールを送信しました」というメッセージを表示
- メール送信失敗時に「メール送信に失敗しました。しばらく待ってから再度お試しください」というメッセージを表示
- メール確認待ち画面で「メールが届かない場合は、スパムフォルダを確認してください」というメッセージを表示

---

### 4. ログの強化

メール送信に関するログを強化することで、問題の原因を特定しやすくなります。

**実装例:**
```typescript
console.log('[Email Registration] Attempting to send confirmation email:', {
  email: registerEmail,
  redirectUrl: redirectUrl,
  timestamp: new Date().toISOString()
})

const { data, error } = await supabase.auth.signUp({
  email: registerEmail,
  password: registerPassword,
  options: {
    emailRedirectTo: redirectUrl
  }
})

if (error) {
  console.error('[Email Registration] SignUp error:', {
    message: error.message,
    status: error.status,
    name: error.name,
    email: registerEmail,
    timestamp: new Date().toISOString()
  })
} else {
  console.log('[Email Registration] SignUp success:', {
    userId: data.user?.id,
    email: data.user?.email,
    hasSession: !!data.session,
    emailConfirmed: !!data.user?.email_confirmed_at,
    timestamp: new Date().toISOString()
  })
}
```

---

## 確認チェックリスト

メールが届かない問題が発生した場合、以下を確認してください：

- [ ] Supabase Dashboard > Authentication > Users でユーザーが作成されているか確認
- [ ] Supabase Dashboard > Logs でメール送信のエラーログを確認
- [ ] ユーザーにスパムフォルダを確認してもらう
- [ ] ブラウザのコンソールで`redirectUrl`が正しく生成されているか確認
- [ ] 環境変数`NEXT_PUBLIC_APP_URL`が正しく設定されているか確認
- [ ] Supabase Dashboard > Authentication > Settings > Email Templates を確認
- [ ] Supabase Dashboard > Authentication > Settings > SMTP Settings を確認
- [ ] メールアドレスの入力が正しいか確認
- [ ] 短時間に複数のメール送信リクエストがないか確認（レート制限の可能性）

---

## 緊急時の対処法

メールが届かない問題が頻繁に発生する場合：

1. **カスタムSMTPサーバーを設定する**（最も効果的）
2. **メール確認を一時的に無効にする**（開発環境のみ）
3. **メール送信の再試行機能を実装する**
4. **ユーザーにメール確認待ち画面で再送信ボタンを提供する**（既に実装済み）

---

## 参考リンク

- [Supabase Authentication - Email Templates](https://supabase.com/docs/guides/auth/auth-email-templates)
- [Supabase Authentication - SMTP Settings](https://supabase.com/docs/guides/auth/auth-smtp)
- [Supabase Authentication - Rate Limits](https://supabase.com/docs/guides/platform/rate-limits)


