# メール確認機能動作確認手順

## 前提条件

1. Supabase Dashboardでメール確認が有効になっていること
   - Authentication > Sign In / Providers > User Signups > **Confirm email** が **ON**
2. リダイレクトURLが設定されていること
   - Authentication > URL Configuration に以下が追加されている：
     - `https://tomorrow-event-platform-store.vercel.app/auth/verify-email`
     - `https://tomorrow-event-platform-organizer.vercel.app/auth/verify-email`

## 動作確認手順

### 1. 新規登録（メールアドレス・パスワード）

#### 出店者アプリ（store）

1. アプリケーションにアクセス
   - `https://tomorrow-event-platform-store.vercel.app`
2. **「新規登録」** をクリック
3. **「メールアドレスで新規登録」** をクリック
4. 以下を入力：
   - メールアドレス（実際に受信できるメールアドレス）
   - パスワード（6文字以上）
   - パスワード（確認）
5. **「登録する」** をクリック
6. ✅ **確認メール送信のメッセージが表示される**ことを確認
   - 「確認メールを送信しました。メール内のリンクをクリックしてメールアドレスを確認してください。」
7. ✅ **初期画面に戻る**ことを確認

#### 主催者アプリ（organizer）

1. アプリケーションにアクセス
   - `https://tomorrow-event-platform-organizer.vercel.app`
2. **「新規登録」** をクリック
3. **「メールアドレスで新規登録」** をクリック
4. 以下を入力：
   - メールアドレス（実際に受信できるメールアドレス）
   - パスワード（6文字以上）
   - パスワード（確認）
5. **「登録する」** をクリック
6. ✅ **確認メール送信のメッセージが表示される**ことを確認
7. ✅ **初期画面に戻る**ことを確認

### 2. 確認メールの受信確認

1. 登録時に使用したメールアドレスの受信トレイを確認
2. ✅ **Supabaseからの確認メールが届いている**ことを確認
   - 件名: 「Confirm your signup」など
   - 送信者: Supabase または設定した送信者名

### 3. メール確認リンクのクリック

1. 確認メールを開く
2. メール内の **「Confirm your email」** または **「メールアドレスを確認」** ボタン/リンクをクリック
3. ✅ **メール確認ページ（`/auth/verify-email`）にリダイレクトされる**ことを確認
4. ✅ **「メールアドレスの確認が完了しました」** というメッセージが表示されることを確認
5. ✅ **3秒後にホームページに自動リダイレクトされる**ことを確認

### 4. ログイン確認

1. メール確認後、ホームページにリダイレクトされる
2. ✅ **ログイン状態になっている**ことを確認
3. ✅ **メール確認バナーが表示されない**ことを確認（確認済みのため）
4. ✅ **登録情報入力画面が表示される**ことを確認

### 5. メール未確認状態でのログイン確認

1. 新しいメールアドレスで新規登録（メール確認リンクはクリックしない）
2. 別のブラウザまたはシークレットモードでアプリにアクセス
3. **「ログイン」** → **「メールアドレスでログイン」** を選択
4. 登録したメールアドレスとパスワードを入力
5. **「ログイン」** をクリック
6. ✅ **ログインできる**ことを確認（メール確認が必須でない場合）
   - または、**「メールアドレスを確認してください」** というエラーが表示される（メール確認が必須の場合）

### 6. メール確認バナーの表示確認

1. メール未確認の状態でログイン
2. ✅ **メール確認バナーが表示される**ことを確認
   - 黄色い背景のバナー
   - 「メールアドレスの確認が必要です」というメッセージ
   - 「確認メールを再送信」ボタン

### 7. 確認メール再送信機能の確認

1. メール確認バナーの **「確認メールを再送信」** ボタンをクリック
2. ✅ **「送信しました」** というメッセージが表示されることを確認
3. ✅ **メールアドレスに確認メールが再送信される**ことを確認

## 確認チェックリスト

### 新規登録
- [ ] メールアドレス・パスワードで新規登録できる
- [ ] 確認メール送信のメッセージが表示される
- [ ] 初期画面に戻る

### メール確認
- [ ] 確認メールが届く
- [ ] メール内のリンクをクリックできる
- [ ] メール確認ページにリダイレクトされる
- [ ] メール確認が完了する
- [ ] ホームページに自動リダイレクトされる

### ログイン
- [ ] メール確認後にログインできる
- [ ] メール確認バナーが表示されない（確認済みの場合）

### メール未確認状態
- [ ] メール未確認でログインできる（または適切なエラーが表示される）
- [ ] メール確認バナーが表示される
- [ ] 確認メール再送信が動作する

## トラブルシューティング

### 確認メールが届かない場合

1. **Supabase Dashboardで確認**
   - Authentication > Users でユーザーが作成されているか確認
   - ユーザーのメールアドレスが正しいか確認

2. **スパムフォルダを確認**
   - 確認メールがスパムフォルダに入っている可能性があります

3. **メール送信設定を確認**
   - Supabase Dashboard > Settings > Auth でメール送信設定を確認
   - カスタムSMTPサーバーを設定している場合は、設定を確認

4. **開発環境の場合**
   - Supabaseの無料プランでは、メール送信が制限される場合があります
   - 本番環境で確認することを推奨

### メール確認リンクをクリックしてもエラーになる場合

1. **リダイレクトURLの設定を確認**
   - Authentication > URL Configuration でリダイレクトURLが正しく設定されているか確認

2. **ブラウザのコンソールを確認**
   - エラーメッセージを確認
   - ネットワークタブでリクエストを確認

3. **URLパラメータを確認**
   - メール内のリンクのURLを確認
   - `token_hash`や`type`パラメータが含まれているか確認

### メール確認バナーが表示されない場合

1. **メール確認状態を確認**
   - Supabase Dashboard > Authentication > Users でユーザーのメール確認状態を確認
   - `email_confirmed_at`が`null`の場合は未確認

2. **ブラウザのコンソールを確認**
   - エラーメッセージがないか確認

## 次のステップ

動作確認が完了したら、本番環境での使用準備が整います。

必要に応じて、以下も検討してください：
- メールテンプレートのカスタマイズ
- カスタムSMTPサーバーの設定（本番環境）
- メール確認の必須/任意の設定

